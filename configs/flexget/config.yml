secrets: variables.yml
templates:

##########
# Global #
# ########
  global:
    regexp:
      reject:
        - \b(s|d)ub(s|bed)?\b: {from: title}   # subbed/dubbed/etc videos
        - \b(duo|tri|quadri|tetra|penta)logy\b: {from: title}   # Series
        - \b3-?D\b: {from: title}   # 3D displays
        - \btrailer\b: {from: title}   # Trailers
        - \bR5\b: {from: title}   
        - \bWEBSCR\b: {from: title}   
        - \bWEB-DL\b: {from: title}   
        - \bWEB\b: {from: title}   
        - \bscreener\b: {from: title}
        - \bTS\b: {from: title}
        - \bCam\b: {from: title}
        - \bTrTd TeaM\b: {from: title}
        - \b\[TNTVillage\]\b: {from: title}
        - \b\[facepalm\]\b: {from: title}
        - \bASAP\b: {from: title}
        - \bNL.Subs.DutchReleaseTeam\b: {from: title}
        - \bITA\b: {from: title}
        - \bR6\b: {from: title}
        - \bTemporada\b: {from: title}
        - \bNORDiC\b: {from: title}
        - \biPad\b: {from: title}
        - \bSCR\b: {from: title}
        - \bMULTi\b: {from: title}
        - \bFASTSUB\b: {from: title}
        - \bVOSTFR\b: {from: title}
        - \bSubtitulado\b: {from: title}
        - '{C_P}': {from: title}   # Poor quality releases
        - /\b(ita|ger|fra|spa|swe|nor|nordic|fr|kor|esp|nl|pl)\b/i: {from: title}
        - /\bDual\b/i: {from: title}
        - /\bJAPANESE\b/i: {from: title}
        - /\bFRENCH\b/i: {from: title}
        - /\bSWEDISH\b/i: {from: title}
        - /\bGERMAN\b/i: {from: title}
        - /\bHINDI\b/i: {from: title}
        - /\bSPANISH\b/i: {from: title}
        - /\bDUTCH\b/i: {from: title}
        - /\bITALIAN\b/i: {from: title}
        - /\bHDCAM\b/i: {from: title}

    content_filter:
      require:
        - '*.avi'
        - '*.mkv'
        - '*.mpg'
        - '*.mpeg'
        - '*.mp4'
        - '*.r0*'
        - '*.part0*'
      reject: 
        - 'password.txt'
        - 'password.zip'
        - '*.wmv'
    domain_delay:
      bt-chat.com: 5 seconds
      torrentz.eu: 5 seconds
    rtorrent_magnet: '{{secrets.global.rtorrent_magnet}}'
    email:
      from: '{{secrets.email.from}}'
      to: '{{secrets.email.to}}'
      subject: '{{secrets.email.subject}}'
      smtp_host: smtp.gmail.com
      smtp_port: 587
      smtp_login: true
      smtp_username: '{{secrets.email.smtp_username}}'
      smtp_password: '{{secrets.email.smtp_password}}'
      smtp_tls: yes
 
    send_telegram:
      bot_token: '{{secrets.telegram.bot_token}}'
      parse_mode: markdown
      recipients:
        - username: '{{secrets.telegram.username}}'
        #- fullname: 
            #first: '{{secrets.telegram.first_name}}'
            #sur: '{{secrets.telegram.sur_name}}'
      template: |+
        *[JambulaTV] The following {{task|replace("s", "(s)")}} have been queued for download:
        
        *{{title}}


##############
#  Templates #
##############
  # TV
  # --
  tv:
    content_size:
      max: 490
    free_space:
      path: '{{secrets.tv.path}}'
      space: 1000
    exists_series:
      - '{{secrets.tv.exists_series}}'
    series:
      settings:
        group 1:
          quality: "h264 xvid !720p"
          propers: no 
          identified_by: ep
          tracking: backfill
    priority: 10
    include: [ '{{secrets.tv.include}}' ]
    download: '{{secrets.tv.download}}'
    verify_ssl_certificates: no

    # Pull TV shows from trakt.tv watchlist
    discover:
      what: 
        - emit_series:
            from_start: yes
        - trakt_list:
            username: '{{secrets.trakt.username}}'
            list: '{{secrets.trakt.watchlist}}'
            type: shows
      from:
        - torrentz: verified

  # Movies 
  #--------
  movies:
    limit_new: 1
    seen_movies:
      matching: strict
    # Filter based on IMDB score, rating, etc
    imdb_required: yes
    imdb:
      min_score: 8.0
      min_votes: 60000
      min_year: 2015
      accept_languages:
        - english
      #reject_genres:
        #- adventure
        #- animation
        #- horror
        #- musical
        
    # Lists
    discover:
      what:
    # List of wanted movies
        - movie_list: wanted_movies
    # Pull movies from trakt.tv watchlist and add to the movie queue
        - trakt_list:
            username: '{{secrets.trakt.username}}'
            list: '{{secrets.trakt.watchlist}}'
            type: movies
      from:
        - torrentz: verified
    # 
    quality: 
      - "h264 xvid"
      - "!dts !cam !10bit"
    content_size:
      max: 49900
      min: 600
    free_space:
      path: '{{secrets.movies.path}}'
      space: 1000
    exists_movie:
      - '{{secrets.movies.exists_movie}}'
    only_new: no
    priority: 15
    download: '{{secrets.movies.download}}'
#    accept_all: yes # Uncomment if IMDB is not used

# Podcasts 
# --------
  podcasts:
    free_space:
      path: '{{secrets.podcasts.path}}'
      space: 1000
    exists:
      - '{{secrets.podcasts.exists}}'
    limit_new: 5
    priority: 5
    include: [ '{{secrets.podcasts.include}}' ]
    exec:
      auto_escape: no
      on_start:
        # Add timestamp to log file
        phase: echo "# $(date '+%F %H:%M'):" >> '{{secrets.podcasts.download_log}}'
      on_output:
        # Copy podcasts URLS to input-file for aria2c
        for_accepted: echo "%(url)s" >> '{{secrets.podcasts.download_file}}'
      on_exit:
        # Add URL to log file
        for_accepted: echo "%(url)s" >> '{{secrets.podcasts.download_log}}'

        # Start aria2
        phase: /bin/sh '{{secrets.podcasts.download_script}}' '{{secrets.podcasts.download_dir}}' '{{secrets.podcasts.download_file}}' '{{secrets.email.to}}'

    accept_all: yes

# Kodi Library 
# ------------
  kodi_library_scan:
    kodi_library:
      action: scan
      category: video
      url: '{{secrets.kodi.url}}'
      port: 8510
      #port: '{{secrets.kodi.port}}'
      username: '{{secrets.kodi.username}}'
      password: '{{secrets.kodi.password}}'


###########
#  TASKS  #
###########
tasks:

  # TV Shows
  # --------
  tv_shows:
    inputs:
      - rss: { url: '{{secrets.tv_feeds.torrentz}}', silent: yes }
      - rss: { url: '{{secrets.tv_feeds.kat}}', silent: yes }
      - rss: { url: '{{secrets.tv_feeds.kickass}}', silent: yes }
      - rss: { url: '{{secrets.tv_feeds.ezrss}}', silent: yes }
      - rss: { url: '{{secrets.tv_feeds.torlock}}', silent: yes }
      - rss: { url: '{{secrets.tv_feeds.mininova}}', silent: yes }
    template: 
      - tv

  # Movies
  # ------
  movies:
    inputs:
      - rss: { url: '{{secrets.movie_feeds.kat}}', silent: yes }
      - rss: { url: '{{secrets.movie_feeds.kickass}}', silent: yes }
      - rss: { url: '{{secrets.movie_feeds.torrentz}}', silent: yes }
      - rss: { url: '{{secrets.movie_feeds.torlock}}', silent: yes }
      - rss: { url: '{{secrets.movie_feeds.mininova}}', silent: yes }
    template: 
      - movies

  # Podcasts
  # --------
  internet_tv:
    template: 
      - podcasts

  # Move TV Shows to Kodi directory
  # -------------------------------
  move_tv_shows:
    priority: 20
    disable:
      - retry_failed
      - email
      - send_telegram # Will send using jambulatv-telegram below
    metainfo_series: yes
    require_field: [series_name, series_id, series_season]
    accept_all: yes
    seen: local
    all_series:
      parse_only: yes
    parsing:
      series: guessit
    filesystem:
      path: 
        - "/{{secrets.tv.series_completed_dir}}"
      recursive: yes
      retrieve: 
        - files
        - dirs
      regexp: '.*\.(avi|mkv|mp4|m4v|iso)$' 
    move:
      to: "/{{secrets.tv.series_jambulatv_dir}}/{{series_name|replace(' ', '_')}}/Season_{{'%02d'|format(series_season)}}"
      filename: "{{series_name}}.{{series_id}}.{{quality|upper}}"
      clean_source: 2
      along:
        - sub
        - srt
        - extrafanart
    exec:
      auto_escape: yes
      on_start:
    # Create dummy 3M file
        phase: truncate -s 3M '/{{secrets.tv.series_completed_dir}}/DO.NOT.REMOVE.ME'
      on_output:
        # Send telegram message
        for_accepted: 
          - jambulatv-telegram sendmessage '{{secrets.telegram.bot_token}}' "[JambulaTV] The Series {{title}} was successfully downloaded. You may find it under 'TV Shows' on your JambulaTV. Enjoy!"
    # 
    template:
      - kodi_library_scan

  # Move Movies to Kodi directory
  # -------------------------------
  move_movies:
    priority: 25
    disable:
      - retry_failed
      - email
      - send_telegram # Will send using jambulatv-telegram below
    accept_all: yes
    seen: local
    parsing:
      movie: guessit
    imdb_lookup: yes
    proper_movies: yes
    require_field: [movie_name, movie_year]
    filesystem:
      path: 
        - "/{{secrets.movies.movies_completed_dir}}"
      recursive: yes
      retrieve: 
        - files
        - dirs
      regexp: '.*\.(avi|mkv|mp4|m4v|iso)$' 
    move:
      to: "/{{secrets.movies.movies_jambulatv_dir}}"
      filename: "{{movie_name|replace(' ', '.')|replace('/', '_')|replace(':', ' -')}}.({{movie_year}}){% if quality|default(False) %}: - {{quality}}{% endif %}"
      clean_source: 2
      along:
        - sub
        - srt
        - extrafanart
    exec:
      auto_escape: yes
      on_start:
    # Create dummy 3M file
        phase: truncate -s 3M '/{{secrets.tv.series_completed_dir}}/DO.NOT.REMOVE.ME'
      on_output:
        # Send telegram message
        for_accepted: 
          - jambulatv-telegram sendmessage '{{secrets.telegram.bot_token}}' "[JambulaTV] The Movie {{title}} was successfully downloaded. You may find it under 'Movies' on your JambulaTV. Enjoy!"
    # 
    template:
      - kodi_library_scan



##############
#  Scheduler #
##############
schedules:
  - tasks: [tv_shows, move_tv_shows]
    schedule:
      day_of_week: '{{secrets.tv.day_of_week}}'
      hour: '{{secrets.tv.hour}}'      
      minute: '{{secrets.tv.minute}}'
      day: '*'
      week: '*'
      month: '*'
      year: '*'

  - tasks: [movies, move_tv_shows]
    schedule:
      day_of_week: '{{secrets.movies.day_of_week}}'
      hour: '{{secrets.movies.hour}}'
      minute: '{{secrets.movies.minute}}'
      day: '*'
      week: '*'
      month: '*'
      year: '*'

  - tasks: [internet_tv]
    schedule:
      day_of_week: '{{secrets.podcasts.day_of_week}}'
      hour: '{{secrets.podcasts.hour}}'
      minute: '{{secrets.podcasts.minute}}'
      day: '*'
      week: '*'
      month: '*'
      year: '*'
