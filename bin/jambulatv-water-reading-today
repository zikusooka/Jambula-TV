#!/bin/sh
#
# This script is used to manually enter water meter readings and 
# indicate whether water is flowing today
#
#  NOTE: To use this script in a  non-interactive mode, Add the
#        arguments WATER_READING_TODAY and WATER_FLOW_TODAY to 
#        command e.g:
#
#        ./jambulatv-water-reading-today [67.37] [Yes|No]
#  
#        You can also use this script interactively at a remote 
#        PC e.g. located in kitchen, and entry input is guided by
#        GUI interface i.e. interface.  Ensure you can connect to
#        remote PC password-lessly via SSH
#
# Jambula Labs @copyright 2020-2021 All rights reserved

# Variables
WATER_REPORTS_DIR=/var/tmp/water_reports
WATER_REPORTS_FILE_TODAY=$WATER_REPORTS_DIR/$(date +%Y%m%d).txt
WATER_REPORTS_FILE_YESTERDAY=$WATER_REPORTS_DIR/$(date --date='yesterday' +%Y%m%d).txt
WATER_REPORTS_FILE_2_DAYS_AGO=$WATER_REPORTS_DIR/$(date --date='2 days ago' +%Y%m%d).txt
WATER_REPORTS_FILE_3_DAYS_AGO=$WATER_REPORTS_DIR/$(date --date='3 days ago' +%Y%m%d).txt
OPERATOR_USER=jambula

WATER_READING_TODAY=$1
WATER_FLOW_TODAY=$2



#################
#  MAIN SCRIPT  #
#################
clear

# Quit if there's already a water report for today
if [[ -e $WATER_REPORTS_FILE_TODAY ]] && \
	[[ "x$WATER_READING_TODAY" = "x" || "x$WATER_FLOW_TODAY" = "x" ]];
then
clear
cat <<ET
There's already a water report for: $(date +'%A, %_d %B %Y')

ET
exit 1
fi

# Create water reports directory if non-existent
[[ -d $WATER_REPORTS_DIR ]] || mkdir -p $WATER_REPORTS_DIR


# Create report header
cat > $WATER_REPORTS_FILE_TODAY <<ET
==============================================================
Water report for $(date +'%A, %_d %B %Y') - $(date +'%_I:%M %p')
==============================================================

ET

# Ask for water reading
if [[ "x$WATER_READING_TODAY" = "x" ]];
then
WATER_READING=$(zenity --title "WATER READING" --entry --text "Enter the water meter reading for today (e.g. 35.40)")

else
WATER_READING=$WATER_READING_TODAY
fi
#
echo "WATER_READING=$WATER_READING" >> $WATER_REPORTS_FILE_TODAY

# Water flow status for today
if [[ "x$WATER_FLOW_TODAY" = "x" ]];
then
	# Ask weather water is flowing
	zenity --title "WATER FLOW" --question --text "Is the water flowing today?"
	WATER_FLOW_STATUS=$?
	if [[ "$WATER_FLOW_STATUS" = "0" ]];
	then
	echo "WATER_FLOWING=y" >> $WATER_REPORTS_FILE_TODAY

	else
	echo "WATER_FLOWING=n" >> $WATER_REPORTS_FILE_TODAY
	fi

else
	if [[ "$WATER_FLOW_TODAY" = "Yes" ]];
	then
	echo "WATER_FLOWING=y" >> $WATER_REPORTS_FILE_TODAY

	elif [[ "$WATER_FLOW_TODAY" = "No" ]];
	then
	echo "WATER_FLOWING=n" >> $WATER_REPORTS_FILE_TODAY

	else
	echo "WATER_FLOWING=n" >> $WATER_REPORTS_FILE_TODAY
	fi
fi


# Create report footer 
cat >> $WATER_REPORTS_FILE_TODAY <<ET

ET


# Change ownership of water reports directory
chown -R $OPERATOR_USER:$OPERATOR_USER $WATER_REPORTS_DIR
