#!/bin/sh
# This is a wrapper script used by icinga2 to connect to a wireless access point
# Jambula Labs @copyright 2019-2020 All rights reserved

# Argument from icinga2 script
ICINGA2_AP_STATUS=$@

SCRIPT_RUNNING_FILE=/tmp/connect_2_ap_running
INTERNET_OFF_FILE=/etc/dnsmasq.d/dns_off.conf
SETUP_COMPLETED_FILE=/usr/share/JambulaTV/html/setup/.initial-setup-completed

PING_CMD=/usr/sbin/fping
PING_CMD_OPTS="-l"
HOST_2_PING=MY_HOST_2_PING

# Available in functions file
INTERNET_WIFI_ISP_CONFIG=/etc/JambulaTV/internet-mobile-wifi.cfg
WIFI_WPA_CONFIG_FILE=/etc/wpa_supplicant/wpa_supplicant.conf
WIFI_INTERFACES_AVAILABLE=$(sudo /usr/sbin/ip link |grep jwlan | wc -l)
# Variable specific to this script
WIFI_SSID=$(grep -i SSID $INTERNET_WIFI_ISP_CONFIG | sed '/^#/d' | cut -d = -f2 | sed 's/"//g')
WIFI_SECURITY_KEY=$(grep -i SECURITY_KEY $INTERNET_WIFI_ISP_CONFIG | sed '/^#/d' | cut -d = -f2 | sed 's/"//g')
OSD_TOOL_CMD="sudo /usr/bin/jambulatv-osd -m"
AP_NOT_FOUND_MSG="WARNING - Wireless Access Point ($WIFI_SSID) Not Available"
AP_FOUND_MSG="Found your WiFi Access Point ($WIFI_SSID). Please wait while I connect to it"
CONNECTED_MSG="Successfully connected to your WiFi Access Point ($WIFI_SSID), Assigning IP Address ..."
INSERT_WIFI_DONGLE_MSG="Please insert your USB Wireless (WiFi) Network Adapter. I will try connecting to $WIFI_SSID shortly ..."

HOSTAPD_CONFIG_FILE=/etc/hostapd/hostapd.conf

# Set WiFi station Interface
WIFI_STATION_INTERFACE=MY_WIFI_STATION_INTERFACE



###############
#  FUNCTIONS  #
###############

# Check if script is already running and internet is off
quit_if_already_running () {

# Check external DNS status
check_external_dns_status 

if [[ -e "$SCRIPT_RUNNING_FILE" ]] && [[ -e "$INTERNET_OFF_FILE" ]];
then
# Remove script running file and continue
rm -f $SCRIPT_RUNNING_FILE

elif [[ -e "$INTERNET_OFF_FILE" ]];
then
logger -s -t $(basename $0) "Internet is Off"
break

elif [[ "$DNS_STATUS" != "0" ]];
then
cat <<ET
logger -s -t $(basename $0) "Connecting to the Internet using the WiFi Access Point (MiFi)"
ET
break 

elif [[ ! -e "$SETUP_COMPLETED_FILE" ]];
then
logger -s -t $(basename $0) "Internet is Off"
break

else
# Quit
exit 1
fi
}

add_script_running_file () {
touch $SCRIPT_RUNNING_FILE
}

remove_script_running_file () {
rm -f $SCRIPT_RUNNING_FILE
}

number_of_interfaces () { 
# Quit if less than 2 WiFi devices are detected
if [[ "$WIFI_INTERFACES_AVAILABLE" -lt "2" ]];
then
logger -s -t $(basename $0) "CRITICAL: Sorry, I did not find a second and/or usable WiFi interface "
exit 2
fi
}

type_of_station_interface () {
# Unsupported r8188eu devices like RTL8188ETV, RTL8188EUS (TP-Link TL-WN723/TL-WN725N)
journalctl -b -o cat --no-pager | grep $WIFI_STATION_INTERFACE | grep r8188eu > /dev/null 2>&1
UNSUPPORTED=$?
# Check to see if supported
if [[ "$UNSUPPORTED" = "0" ]];
then
IW_COMPATIBLE=no
else
IW_COMPATIBLE=yes
fi
}

check_4_wifi_dongle () {
# Test to see if WiFi stick is now present
if [[ "$IW_COMPATIBLE" = "yes" ]];
then
# Using iw command
/usr/sbin/iw dev ${WIFI_STATION_INTERFACE} info > /dev/null 2>&1
else
# Using iwconfig
/usr/sbin/iwconfig ${WIFI_STATION_INTERFACE} | grep ${WIFI_STATION_INTERFACE} > /dev/null 2>&1
fi
WIFI_STICK_PRESENT=$?
until [[ "$WIFI_STICK_PRESENT" = "0" ]];
do
# Display success message on Screen
$OSD_TOOL_CMD "$INSERT_WIFI_DONGLE_MSG"
# Pause while waiting for insertion
sleep 60
# Test if WiFi stick is now present
if [[ "$IW_COMPATIBLE" = "yes" ]];
then
# Using iw command
/usr/sbin/iw dev ${WIFI_STATION_INTERFACE} info > /dev/null 2>&1
else
# Using iwconfig command
/usr/sbin/iwconfig ${WIFI_STATION_INTERFACE} | grep ${WIFI_STATION_INTERFACE} > /dev/null 2>&1
fi
WIFI_STICK_PRESENT=$?
done
}

scan_4_wifi () {
# Take station UP
sudo /usr/sbin/ip link set $WIFI_STATION_INTERFACE up
#
# Scan for AP, and get scanned SSID
if [[ "$IW_COMPATIBLE" = "yes" ]];
then
# Using iw command
sudo /usr/sbin/iw dev $WIFI_STATION_INTERFACE scan | grep -w "SSID: $WIFI_SSID" > /dev/null 2>&1
AP_EXISTENCE=$?
else
# Using iwlist command
sudo iwlist $WIFI_STATION_INTERFACE scan | grep -w "ESSID:\"$WIFI_SSID\"" > /dev/null 2>&1
AP_EXISTENCE=$?
fi
#
# See if there's a match
if [[ "$AP_EXISTENCE" = "0" ]];
then
WIFI_FOUND=yes
# Notify
logger -s -t $(basename $0) "$AP_FOUND_MSG"
else
WIFI_FOUND=no
logger -s -t $(basename $0) "$AP_NOT_FOUND_MSG"
fi
export WIFI_FOUND
}

disconnect_4rm_access_point () {
# PIDs
DHCLIENT_PID=$(sudo ps auxw | grep dhclient | grep $WIFI_STATION_INTERFACE | head -1 | awk {'print $2'})
WPA_SUPPLICANT_PID=$(sudo ps auxw | grep wpa_supplicant | grep $WIFI_STATION_INTERFACE | head -1 | awk {'print $2'})
#
# Kill dhclient
[[ "x$DHCLIENT_PID" = "x" ]] || sudo kill $DHCLIENT_PID >> /dev/null
# Kill wpa_supplicant
[[ "x$WPA_SUPPLICANT_PID" = "x" ]] || sudo kill $WPA_SUPPLICANT_PID >> /dev/null
# Flush Wifi station interface
sudo /usr/sbin/ip addr flush dev $WIFI_STATION_INTERFACE 
}

generate_wpa_config () {
grep "psk=\"$WIFI_SECURITY_KEY\"" $WIFI_WPA_CONFIG_FILE > /dev/null 2>&1
PASSPHRASE_MATCH=$?
grep "ssid=\"$WIFI_SSID\"" $WIFI_WPA_CONFIG_FILE > /dev/null 2>&1
SSID_MATCH=$?
# Generate a wpa/wpa2 configuration file if not yet set
if [[ "$PASSPHRASE_MATCH" != "0" ]] || [[ "$SSID_MATCH" != "0" ]];
then
sudo wpa_passphrase "$WIFI_SSID" "$WIFI_SECURITY_KEY" > $WIFI_WPA_CONFIG_FILE
fi
}

connect_2_access_point () {
# Disconnect any existing WiFi processes
disconnect_4rm_access_point
# Connect to HotSpot
sudo wpa_supplicant -B -i $WIFI_STATION_INTERFACE -c $WIFI_WPA_CONFIG_FILE
}

check_link_status () {
# Check link status
if [[ "$IW_COMPATIBLE" = "yes" ]];
then
# Using iw command
WIFI_LINK_STATUS=$(sudo /usr/sbin/iw dev $WIFI_STATION_INTERFACE link)
else
# Using iwconfig command
WIFI_LINK_STATUS=$(sudo /usr/sbin/iwconfig $WIFI_STATION_INTERFACE | awk -F':' '/Access Point/ {print $3}' | awk '{print $1}')
fi
#
if [[ "$WIFI_LINK_STATUS" = "Not connected." ]] || [[ "$WIFI_LINK_STATUS" = "Not-Associated" ]];
then
logger -s -t $(basename $0) "Connection to $WIFI_SSID failed!. Exiting ..."
exit 1
else
# Beep to alert: Connected WiFi AP
/usr/bin/beep
# Display success message on Screen
$OSD_TOOL_CMD "$CONNECTED_MSG"
fi
}

disable_dns_servers_assignment () {
[[ -e /etc/dhcp/dhclient-enter-hooks ]] || \
	cat > /etc/dhcp/dhclient-enter-hooks <<ET
#!/bin/sh
make_resolv_conf () {
:
logger -s -t \$(basename \$0) "Info: JambulaTV will ignore any DNS server IP addresses assigned to \$interface ..."
}
ET

# Make dhclient-enter-hooks script executable
chmod 755 /etc/dhcp/dhclient-enter-hooks
}

get_ip_address () {
# Remove previous/failed dhclient process 
DHCLIENT_FAILED_PID=$(ps auxw | grep dhclient | grep ${WIFI_STATION_INTERFACE} | awk {'print $2'} | tail -1)
# Kill existing dhclient process
[[ "x$DHCLIENT_FAILED_PID" = "x" ]] || kill $DHCLIENT_FAILED_PID
# Clear default route
/usr/sbin/ip route del default
# Disable assignment of DNS servers by Access Point
disable_dns_servers_assignment
# Get IP/Gateway addresses, and other DHCP info (NOTE: Run dhclient in background!)
sudo /sbin/dhclient -H $(hostname -s) -q -lf /var/lib/dhclient/dhclient--${WIFI_STATION_INTERFACE}.lease -pf /var/run/dhclient-${WIFI_STATION_INTERFACE}.pid ${WIFI_STATION_INTERFACE}
}

wait_4_ip_address () {
IP_ADDRESS_ASSIGNED=255
# Wait for WiFi interface to be assigned an IP address 
while [[ "$IP_ADDRESS_ASSIGNED" != "0" ]]
do
logger -s -t $(basename $0) "Waiting for WiFi Interface (${WIFI_STATION_INTERFACE}) to be assigned an IP address"
sleep 1
/usr/sbin/ip addr show ${WIFI_STATION_INTERFACE} | grep inet > /dev/null 2>&1
IP_ADDRESS_ASSIGNED=$?
done
}

make_this_internet_gateway () {
# Allow IP masquerading through this box
/bin/echo 1 > /proc/sys/net/ipv4/ip_forward
/usr/sbin/iptables -t nat -A POSTROUTING -o ${WIFI_STATION_INTERFACE} -j MASQUERADE
}

start_presence_detection_via_mifi () {
if [[ -e $SETUP_COMPLETED_FILE ]] && \
	[[ "$(systemctl is-enabled presence-detection-via-mifi.service)" = "enabled" && \
	"$(systemctl is-active presence-detection-via-mifi.service)" != "active" ]];
then
# Start presence detection using MiFi: Restart systemd unit if enabled but not active
logger -s -t $(basename $0) "Starting Presence Detection using MiFi Router"
systemctl restart presence-detection-via-mifi.service 
fi
}

quit_not_found () {
if [[ $WIFI_FOUND != yes ]];
then
logger -s -t $(basename $0) "$AP_NOT_FOUND_MSG"
exit 1
fi
}

keep_alive () {
$PING_CMD $PING_CMD_OPTS $HOST_2_PING > /dev/null 2>&1 &
}

check_external_dns_status () {
host -W1 $HOST_2_PING > /dev/null 2>&1
DNS_STATUS=$?
}



#################
#  MAIN SCRIPT  #
#################

# Quit if script is already running
quit_if_already_running

# Kill ping if keep_alive function is activated
#killall fping

# Find WiFi interface to be used as station
number_of_interfaces

# See if station device is properly supported i.e. iw command compatible
type_of_station_interface

# Act according to who called this script
case $ICINGA2_AP_STATUS in
OK)
# Add script running file
add_script_running_file
# Started by icinga2
logger -s -t $(basename $0) "Wireless Access Point ($WIFI_SSID) Available"
;;
WARNING)
# Quit script since Icinga2 detects no WiFi AP.  Before though, kill any previous WiFi
# connections
disconnect_4rm_access_point
exit 1
;;
*)
# Scan for WiFi AP If not running via icinga2 i.e. manual
scan_4_wifi
quit_not_found
;;
esac

# Check to see if USB WiFi dongle is inserted
check_4_wifi_dongle

# Go futher if there's available AP
generate_wpa_config
connect_2_access_point 
sleep 5
check_link_status
get_ip_address
wait_4_ip_address
make_this_internet_gateway

# Start presence detection using MiFi: Restart systemd unit if enabled but not active
start_presence_detection_via_mifi

# Reload coova-chilli in order to change default gateway device and DNS settings
#/usr/bin/jambulatv-chilli restart

#keep_alive
remove_script_running_file
