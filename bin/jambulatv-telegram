#!/bin/sh
TELEGRAM_METHOD_NAME=$1
TELEGRAM_API_BOT=$2
CHAT_ID=$3
TELEGRAM_ARGUMENTS="$4"
TELEGRAM_API_URL="https://api.telegram.org"


# Functions
# ---------
#
usage () {
clear
if [ "x$TELEGRAM_METHOD_NAME" = "x" ];
then
echo "Usage:  ./`basename $0` [METHOD]
"
exit 1
fi

if [ "x$TELEGRAM_API_BOT" = "x" ];
then
echo "Usage:  ./`basename $0` $TELEGRAM_METHOD_NAME [TELEGRAM_API_BOT] 
"
exit 1
fi

if [ "x$CHAT_ID" = "x" ];
then
echo "Usage:  ./`basename $0` $TELEGRAM_METHOD_NAME $TELEGRAM_API_BOT [CHAT_ID]
"
exit 1
fi

if [ "x$TELEGRAM_ARGUMENTS" = "x" ];
then
case $TELEGRAM_METHOD_NAME in
[Ss][Ee][Nn][Dd][Mm][Ee][Ss][Ss][Aa][Gg][Ee])
ARGUMENTS=TELEGRAM_MESSAGE
;;
[Ss][Ee][Nn][Dd][Ii][Mm][Aa][Gg][Ee][Dd][Ii][Ss][Kk])
ARGUMENTS=IMAGE_PATH_eg_/tmp/bell.png
;;
esac
echo "Usage:  ./`basename $0` $TELEGRAM_METHOD_NAME $TELEGRAM_API_BOT $CHAT_ID [$ARGUMENTS]
"
exit 1
fi
}

# Chat ID
get_chat_id () {
TELEGRAM_CHAT_ID=$(curl -s -X POST $TELEGRAM_API_URL/bot$TELEGRAM_API_BOT/getUpdates | jq . | grep \"id\": | sort -u | head -1 | awk {'print $2'})
if [ "x$TELEGRAM_CHAT_ID" = "x" ];
then
TELEGRAM_CHAT_ID=$CHAT_ID
fi
}

# Send
send_message () {
curl -s -X POST $TELEGRAM_API_URL/bot$TELEGRAM_API_BOT/sendMessage \
	-d chat_id=$TELEGRAM_CHAT_ID \
	-d text="$TELEGRAM_ARGUMENTS" \
	-d parse_mode="markdown" > /dev/null 2>&1
}

send_image_disk () {
curl -s -X POST $TELEGRAM_API_URL/bot$TELEGRAM_API_BOT/sendPhoto \
	-F chat_id=$TELEGRAM_CHAT_ID \
	-F photo=@$TELEGRAM_ARGUMENTS > /dev/null 2>&1
}



# Main Script
# -----------
#
usage

case $TELEGRAM_METHOD_NAME in
[Ss][Ee][Nn][Dd][Mm][Ee][Ss][Ss][Aa][Gg][Ee])
get_chat_id 
send_message
;;

[Ss][Ee][Nn][Dd][Ii][Mm][Aa][Gg][Ee][Dd][Ii][Ss][Kk])
get_chat_id 
send_image_disk
;;

esac
