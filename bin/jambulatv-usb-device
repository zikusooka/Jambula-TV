#!/bin/sh
# This is a utility script used in rare occassions where reset of usb gadget is required
# Jambula Labs @copyright 2017-2018 All rights reserved

# Variables
action=$1
idVendor=$2
idProduct=$3



###############
#  FUNCTIONS  #
###############

usage (){
if [[ "x$action" = "x" || "x${idVendor}" = "x" || "x${idProduct}" = "x" ]];
then
clear
# Usage
cat <<EOF
Usage: $(basename $0) [eject|insert|reinsert|reset] [idVendor] [idProduct]

$(lsusb | cut -d : -f2- | sed 's:^ ID ::g' | grep -Ev 'Linux Foundation')

EOF
# Quit
exit 1
fi
}

get_bus_dev_path () {
BUS_ID=$(lsusb -d ${idVendor}:${idProduct} | cut -d : -f1 | awk {'print $2'})
DEVICE_ID=$(lsusb -d ${idVendor}:${idProduct} | cut -d : -f1 | awk {'print $4'})
BUS_DEV_PATH=$(journalctl -b -o cat --no-pager | grep -i "idVendor=${idVendor}, idProduct=${idProduct}" | cut -d ':' -f1 | awk {'print $2'} | tail -1)
}



#################
#  MAIN SCRIPT  #
#################

usage

get_bus_dev_path

case $action in

eject)
# Test for existence of path
if [ -e /sys/bus/usb/devices/$BUS_DEV_PATH/authorized ];
then
# Eject USB device depending on what was specified
echo "JambulaTV: Ejecting USB device ..."
echo 0 > /sys/bus/usb/devices/$BUS_DEV_PATH/authorized
else
clear
echo "Error: The file path [/sys/bus/usb/devices/$BUS_DEV_PATH/authorized] does NOT exist!"
exit 1
fi
;;

insert)
# Test for existence of path
if [ -e /sys/bus/usb/devices/$BUS_DEV_PATH/authorized ];
then
# Insert USB device depending on what was specified
echo "JambulaTV: Inserting USB device ..."
echo 1 > /sys/bus/usb/devices/$BUS_DEV_PATH/authorized
else
clear
echo "Error: The file path [/sys/bus/usb/devices/$BUS_DEV_PATH/authorized] does NOT exist!"
exit 1
fi
;;

reinsert)
# Eject or Insert USB device depending on what was specified
$0 eject ${idVendor} ${idProduct}
$0 insert ${idVendor} ${idProduct}
;;

reset)
usbreset /dev/bus/usb/$BUS_ID/$DEVICE_ID
;;

*)
usage
;;

esac
