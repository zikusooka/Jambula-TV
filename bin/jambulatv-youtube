#!/bin/sh
# This script is used to extract manifest URLs from youtube videos using CLI.
# Use it to for example:
# - Play videos using kodi youtube addon
# - Add TV channels in IPTV m3u8 playlists
# Jambula Labs @copyright 2017-2018 All rights reserved

# Variables
YOUTUBE_USER_URL="https://www.youtube.com/user"
YOUTUBE_CHANNEL_URL="https://www.youtube.com/channel"
YOUTUBE_DL_CMD="/usr/bin/youtube-dl"
YOUTUBE_VARIABLES_TEMP_FILE="/tmp/youtube_variables"
CURL_CMD="/usr/bin/curl -s"

# Favorite youtube video IDs
# --------------------------
# NTV Uganda
NTV_UGANDA_VIDEO_ID=$($CURL_CMD $YOUTUBE_USER_URL/ntvuganda | grep -i "NTV Uganda Livestream" | grep -oP '(?<=href="/watch).+?(?=">NTV Uganda Livestream</a>)' | sed "s:?v=::g" | uniq)

# Spark TV Uganda
SPARK_TV_UGANDA_VIDEO_ID=$($CURL_CMD $YOUTUBE_USER_URL/ntvuganda | grep -i "Spark TV Live Stream" | grep -oP '(?<=href="/watch).+?(?=">Spark TV Live Stream</a>)' | sed "s:?v=::g" | uniq)

# Bukedde TV Uganda
BUKEDDE_TV_UGANDA_VIDEO_ID=$($CURL_CMD $YOUTUBE_USER_URL/bukeddetv | grep -i "Bukedde TV Live Stream" | grep -oP '(?<=href="/watch).+?(?=">Bukedde TV Live Stream</a>)' | sed "s:?v=::g" | uniq)

# KTN Kenya (Nairobi Kenya)
KTN_KENYA_VIDEO_ID=$($CURL_CMD $YOUTUBE_USER_URL/standardgroupkenya | grep -i "KTN News Live Stream" | grep -oP '(?<=href="/watch).+?(?=">KTN News Live Stream \(Nairobi Kenya\)</a>)' | sed "s:?v=::g" | uniq)

# NTV Kenya
NTV_KENYA_LIVE_CHANNEL_PAGE_ID=$($CURL_CMD $YOUTUBE_USER_URL/qtvkenya/channels | awk -F: '/title="Live"/ { print $0 }' | grep -oP '(?<=href="/channel/).+?(?=">Live</a>)' | uniq)
NTV_KENYA_VIDEO_ID=$($CURL_CMD $YOUTUBE_CHANNEL_URL/$NTV_KENYA_LIVE_CHANNEL_PAGE_ID | grep "NTV Kenya Live Stream" | grep -oP '(?<=href="/watch).+?(?=">NTV Kenya Live Stream</a>)' | sed "s:?v=::g")

# TVC News Nigeria
TVC_NEWS_NIGERIA_VIDEO_ID=$($CURL_CMD $YOUTUBE_CHANNEL_URL/UCgp4A6I8LCWrhUzn-5SbKvA | awk -F: '/title="TVC News Nigeria Live"/ { print $0 }' | grep -oP '(?<=href="/watch).+?(?=">TVC News Nigeria Live</a>)' | uniq | sed "s:?v=::g")

# CNN
CNN_VIDEO_ID=$($CURL_CMD $YOUTUBE_USER_URL/wuchst/feed | grep -i "CNN Live Stream" | grep -oP '(?<=href="/watch).+?(?=">CNN Live Stream</a>)' | sed "s:?v=::g" | uniq)

# Fox News
FOX_NEWS_VIDEO_ID=$($CURL_CMD $YOUTUBE_CHANNEL_URL/UCEwvI5DyrSEUvOtWGOze9cQ | awk -F: '/title="Fox News Live Stream ▪ HD"/ { print $0 }' | grep -oP '(?<=href="/watch).+?(?=">Fox News Live Stream ▪ HD</a>)' | uniq | sed "s:?v=::g")



#################
#  MAIN SCRIPT  #
#################
#
# Set Channel
CHANNEL=$(echo $@ | sed 's:"::g')
#
# Set Youtube Video ID
case "$CHANNEL" in
# NTV Uganda | NTVU
[Nn][Tt][Vv]*[Uu][Gg][Aa][Nn][Dd][Aa]|[Nn][Tt][Vv][Uu])
YOUTUBE_VIDEO_ID=$NTV_UGANDA_VIDEO_ID
;;
# Spark Uganda | Spark
[Ss][Pp][Aa][Rr][Kk]*[Uu][Gg][Aa][Nn][Dd][Aa]|[Ss][Pp][Aa][Rr][Kk])
YOUTUBE_VIDEO_ID=$SPARK_TV_UGANDA_VIDEO_ID
;;
# BUKEDDE_TV_UGANDA
[Bb][Uu][Kk][Ee][Dd][Dd][Ee][Tt][Vv])
YOUTUBE_VIDEO_ID=$BUKEDDE_TV_UGANDA_VIDEO_ID
;;
# KTN Kenya | KTN
[Kk][Tt][Nn]*[Kk][Ee][Nn][Yy][Aa]|[Kk][Tt][Nn])
YOUTUBE_VIDEO_ID=$KTN_KENYA_VIDEO_ID
;;
# NTV Kenya | NTVK
[Nn][Tt][Vv]*[Kk][Ee][Nn][Yy][Aa]|[Nn][Tt][Vv][Kk])
YOUTUBE_VIDEO_ID=$NTV_KENYA_VIDEO_ID
;;
# TVC_NEWS_NIGERIA
[Tt][Vv][Cc][Nn][Ee][Ww][Ss])
YOUTUBE_VIDEO_ID=$TVC_NEWS_NIGERIA_VIDEO_ID
;;
# CNN
[Cc][Nn][Nn])
YOUTUBE_VIDEO_ID=$CNN_VIDEO_ID
;;
# Fox News
[Ff][Oo][Xx]*[Nn][Ee][Ww][Ss])
YOUTUBE_VIDEO_ID=$FOX_NEWS_VIDEO_ID
;;
*)
YOUTUBE_VIDEO_ID="$CHANNEL"
esac

# Quit if no Youtube ID is found 
$YOUTUBE_DL_CMD --get-id $YOUTUBE_VIDEO_ID > /dev/null 2>&1
YTEXITVAL=$?
if [ "$YTEXITVAL" != "0" ];
then
echo "Error: No Youtube ID was found for $CHANNEL, quitting ..."
exit 0
fi

# Youtube Manifest URL
YOUTUBE_MANIFEST_URL=$($YOUTUBE_DL_CMD -g $YOUTUBE_VIDEO_ID | grep http | head -1)

# Remove Youtube variables temp file if it exists
[ -e $YOUTUBE_VARIABLES_TEMP_FILE ] && rm -f $YOUTUBE_VARIABLES_TEMP_FILE

# Create a Youtube variables temp file for other tools to use
cat > $YOUTUBE_VARIABLES_TEMP_FILE <<EOF
YOUTUBE_VIDEO_ID=$YOUTUBE_VIDEO_ID
YOUTUBE_MANIFEST_URL=$YOUTUBE_MANIFEST_URL
EOF

# Export set Youtube variables
export YOUTUBE_VIDEO_ID YOUTUBE_MANIFEST_URL
