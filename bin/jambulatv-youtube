#!/bin/sh
# This script is used to extract manifest URLs from youtube videos using CLI. Use it to for example:
# - Play videos using kodi youtube addon
# - Add TV channels in IPTV m3u8 playlists
#
# Jambula Labs @copyright 2017-2018 All rights reserved

# Variables
YOUTUBE_USER_URL="https://www.youtube.com/user"
YOUTUBE_CHANNEL_URL="https://www.youtube.com/channel"
YOUTUBE_WATCH_URL="https://www.youtube.com/watch?v"
YOUTUBE_DL_CMD="/usr/bin/youtube-dl"
YOUTUBE_DL_OPTS="-q -4 --prefer-insecure --no-check-certificate --geo-bypass"
YOUTUBE_VARIABLES_TEMP_FILE="/tmp/youtube_variables"

# Video Format to use depending on connection
YOUTUBE_VIDEO_FORMAT=93
# Video Quality definitions according to format selected 
case $YOUTUBE_VIDEO_FORMAT in
91)
YOUTUBE_VIDEO_QUALITY="mp4   256x144   HLS   197k    avc1.4d400c   mp4a.40.5@ 48k   (91)"
;;
92)
YOUTUBE_VIDEO_QUALITY="mp4   426x240   HLS   338k    avc1.4d4015   mp4a.40.5@ 48k   (92)"
;;
93)
YOUTUBE_VIDEO_QUALITY="mp4   640x360   HLS   829k    avc1.4d401e   mp4a.40.2@128k   (93)"
;;
94)
YOUTUBE_VIDEO_QUALITY="mp4   854x480   HLS   1380k   avc1.4d401f   mp4a.40.2@128k   (94)"
;;
esac

CURL_CMD="/usr/bin/curl"
CURL_OPTS="-s -S -G -L -m 60"

HTTP_BROWSER_USERAGENT="Mozilla/5.0" #IMPORTANT: Do Not change this to typical user agent string.  Won't work!
HTTP_BROWSER_COMMAND="$CURL_CMD $CURL_OPTS -A '$HTTP_BROWSER_USERAGENT'"

STREAM_NAME=$(echo $@ | sed 's:"::g')



###############
#  FUNCTIONS  #
###############
# Usage
usage () {
if [ "x$STREAM_NAME" = "x" ];
then
clear
cat <<EOF
Usage:  $(basename $0) [STREAM NAME] 

Supported Youtube streams:
--------------------------
ntv uganda
sparktv uganda
bukeddetv uganda
ktn kenya
ntv kenya
tvc news nigeria
fox news
cnn

EOF
exit 1
fi
}

# Search for Youtube IDs
youtube_search_video_id () {
#
# Youtube search variables
YOUTUBE_SEARCH_URL=https://www.youtube.com/results
YOUTUBE_SEARCH_PHRASE="$@"
YOUTUBE_SEARCH_TEXT="$(echo "$YOUTUBE_SEARCH_PHRASE" | sed -s "s: :+:g")"
YOUTUBE_SEARCH_FILTER="CAMSBAgCQAFQFA%253D%253D"
YOUTUBE_SEARCH_OUTPUT_FILE=/tmp/youtube_search_results
YOUTUBE_SEARCH_SITE_LINKS_FILE=/tmp/youtube_links_found
#
# Youtube Search with filters: Live, Today, View Count
$HTTP_BROWSER_COMMAND -o $YOUTUBE_SEARCH_OUTPUT_FILE \
	${YOUTUBE_SEARCH_URL}?q=$YOUTUBE_SEARCH_TEXT -d sp="$YOUTUBE_SEARCH_FILTER"
#
# Filter out HTML tags from search output. Strip out Youtube links
YOUTUBE_VIDEO_ID=$(grep -i "$YOUTUBE_SEARCH_PHRASE" $YOUTUBE_SEARCH_OUTPUT_FILE | grep -oP '(?<=href="/watch\?v=).+?(?=")' | uniq | head -1)
#
# Export Youtube ID
export YOUTUBE_VIDEO_ID
}

# Youtube Video IDs
youtube_video_id_ntv_uganda () {
YOUTUBE_VIDEO_ID=$($HTTP_BROWSER_COMMAND $YOUTUBE_USER_URL/ntvuganda | grep -i "NTV Uganda Livestream" | grep -oP '(?<=href="/watch\?v=).+?(?=")' | uniq | head -1)
}

youtube_video_id_sparktv_uganda () {
YOUTUBE_VIDEO_ID=$($HTTP_BROWSER_COMMAND $YOUTUBE_USER_URL/ntvuganda | grep -i "Spark TV Live Stream" | grep -oP '(?<=href="/watch\?v=).+?(?=")' | uniq | head -1)
}

youtube_video_id_bukeddetv_uganda () {
YOUTUBE_VIDEO_ID=$($HTTP_BROWSER_COMMAND $YOUTUBE_USER_URL/bukeddetv | grep -i "Bukedde TV Live Stream" | grep -oP '(?<=href="/watch\?v=).+?(?=")' | uniq | head -1)
}

youtube_video_id_ktn_kenya () {
YOUTUBE_VIDEO_ID=$($HTTP_BROWSER_COMMAND $YOUTUBE_USER_URL/standardgroupkenya | grep -i "KTN News Live Stream" | grep -oP '(?<=href="/watch\?v=).+?(?=")' | uniq | head -1)
}

youtube_video_id_ntv_kenya () {
YOUTUBE_LIVE_CHANNEL_PAGE_ID=$($HTTP_BROWSER_COMMAND $YOUTUBE_USER_URL/qtvkenya/channels | awk -F: '/title="Live"/ { print $0 }' | grep -oP '(?<=href="/channel/).+?(?=">Live)' | uniq)
YOUTUBE_VIDEO_ID=$($HTTP_BROWSER_COMMAND $YOUTUBE_CHANNEL_URL/$YOUTUBE_LIVE_CHANNEL_PAGE_ID | grep "NTV Kenya Live Stream" | grep -oP '(?<=href="/watch\?v=).+?(?=")' | uniq | head -1)
}

youtube_video_id_tvc_news_nigeria () {
YOUTUBE_VIDEO_ID=$($HTTP_BROWSER_COMMAND $YOUTUBE_CHANNEL_URL/UCgp4A6I8LCWrhUzn-5SbKvA | awk -F: '/title="TVC News Nigeria Live"/ { print $0 }' | grep -oP '(?<=href="/watch\?v=).+?(?=")' | uniq | head -1)
}

youtube_video_id_fox_news () {
YOUTUBE_VIDEO_ID=$($HTTP_BROWSER_COMMAND $YOUTUBE_CHANNEL_URL/UCEwvI5DyrSEUvOtWGOze9cQ | awk -F: '/title="Fox News Live Stream â–ª HD"/ { print $0 }' | grep -oP '(?<=href="/watch\?v=).+?(?=")' | uniq | head -1)
}

youtube_video_id_cnn () {
youtube_search_video_id "CNN Live Stream"
YOUTUBE_VIDEO_ID=$YOUTUBE_VIDEO_ID
}



#################
#  MAIN SCRIPT  #
#################
# Usage
usage

# Set Youtube Video ID
case "$STREAM_NAME" in
# NTV Uganda | NTVU
[Nn][Tt][Vv]*[Uu][Gg][Aa][Nn][Dd][Aa])
youtube_video_id_ntv_uganda
;;
# Spark Uganda | Spark
[Ss][Pp][Aa][Rr][Kk][Tt][Vv]*[Uu][Gg][Aa][Nn][Dd][Aa])
youtube_video_id_sparktv_uganda
;;
# BUKEDDE_TV_UGANDA
[Bb][Uu][Kk][Ee][Dd][Dd][Ee][Tt][Vv]*[Uu][Gg][Aa][Nn][Dd][Aa])
youtube_video_id_bukeddetv_uganda
;;
# KTN Kenya | KTN
[Kk][Tt][Nn]*[Kk][Ee][Nn][Yy][Aa])
youtube_video_id_ktn_kenya
;;
# NTV Kenya | NTVK
[Nn][Tt][Vv]*[Kk][Ee][Nn][Yy][Aa])
youtube_video_id_ntv_kenya
;;
# TVC_NEWS_NIGERIA
[Tt][Vv][Cc]*[Nn][Ee][Ww][Ss]*[Nn][Ii][Gg][Ee][Rr][Ii][Aa])
youtube_video_id_tvc_news_nigeria
;;
# Fox News
[Ff][Oo][Xx]*[Nn][Ee][Ww][Ss])
youtube_video_id_fox_news
;;
# CNN
[Cc][Nn][Nn])
youtube_video_id_cnn
;;
esac

# Quit if no Youtube ID is found 
if [ "x$YOUTUBE_VIDEO_ID" = "x" ];
then
logger -s -t $(basename $0) "Error: No Youtube ID was found for $STREAM_NAME, quitting ..."
exit 1
fi

# Get Youtube Manifest URL
YOUTUBE_MANIFEST_URL=$($YOUTUBE_DL_CMD $YOUTUBE_DL_OPTS -f $YOUTUBE_VIDEO_FORMAT -g --youtube-skip-dash-manifest $YOUTUBE_VIDEO_ID | grep http | head -1)

# Remove Youtube variables temp file if it exists
[ -e $YOUTUBE_VARIABLES_TEMP_FILE ] && sudo rm -f $YOUTUBE_VARIABLES_TEMP_FILE

# Create a Youtube variables temp file for other tools to use
cat > $YOUTUBE_VARIABLES_TEMP_FILE <<EOF
YOUTUBE_VIDEO_ID=${YOUTUBE_VIDEO_ID}
YOUTUBE_VIDEO_URL=${YOUTUBE_WATCH_URL}=${YOUTUBE_VIDEO_ID}
YOUTUBE_VIDEO_QUALITY=${YOUTUBE_VIDEO_QUALITY}
YOUTUBE_MANIFEST_URL=${YOUTUBE_MANIFEST_URL}
EOF

# Export set Youtube variables
export YOUTUBE_VIDEO_ID YOUTUBE_VIDEO_URL YOUTUBE_VIDEO_QUALITY YOUTUBE_MANIFEST_URL 
