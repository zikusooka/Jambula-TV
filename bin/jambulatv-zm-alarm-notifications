#!/bin/sh

ZM_CAMERA_ID=$1
ZM_CAMERA_NAME=$2
ZM_CAMERA_EVENT_ID=$3
ZM_TIME=$(date)
ZM_EVENTS_DIR=/tmp
ZM_HOST_LOCAL=127.0.0.1
ZM_HOST_WIFI=172.16.0.1
ZM_PORT=8520
ZM_ROOT_URL_LOCAL=http://$ZM_HOST_LOCAL:$ZM_PORT
ZM_ROOT_URL_WIFI=http://$ZM_HOST_WIFI:$ZM_PORT
ZM_WATCH_URL="$ZM_ROOT_URL_LOCAL/jpeg.cgi?mode=single&monitor=${ZM_CAMERA_ID}&scale=100"

# Edit Notification message templates here
NOTIFICATION_SUBJECT="*[JambulaTV] CCTV Security Alert: Motion Detected on $ZM_CAMERA_NAME Camera*"
NOTIFICATION_MESSAGE="Motion Was Detected by Camera No.$ZM_CAMERA_ID ($ZM_CAMERA_NAME) at $ZM_TIME.  The Video of this Event has been logged and is viewable at: $ZM_ROOT_URL_WIFI/index.php?view=event%26eid=${ZM_CAMERA_EVENT_ID}"

# Telegram
TELEGRAM_CREDENTIALS_CONFIG=/etc/JambulaTV/messaging-telegram.cfg

# Email
EMAIL_CREDENTIALS_CONFIG=/etc/JambulaTV/messaging-email.cfg
EMAIL_NOTIFICATION_ADDRESS=$(grep -i EMAIL_TO_ADDRESS $EMAIL_CREDENTIALS_CONFIG | sed '/^#/d' | cut -d = -f2 | sed 's/"//g')
EMAIL_SCRIPT="/usr/bin/jambulatv-email"

# OSD
OSD_SCRIPT=/usr/bin/jambulatv-osd


# Usage 
# ------
# Camera ID
if [ "x$ZM_CAMERA_ID" = "x" ];
then
echo "Usage:  ./`basename $0` [ZM_CAMERA_ID] [ZM_CAMERA_NAME] [ZM_CAMERA_EVENT_ID]
"
exit 1
fi
# Camera Name
if [ "x$ZM_CAMERA_NAME" = "x" ];
then
echo "Usage:  ./`basename $0` $ZM_CAMERA_ID [ZM_CAMERA_NAME] [ZM_CAMERA_EVENT_ID]
"
exit 1
fi
# Camera Event ID
if [ "x$ZM_CAMERA_EVENT_ID" = "x" ];
then
echo "Usage:  ./`basename $0` $ZM_CAMERA_ID $ZM_CAMERA_NAME [ZM_CAMERA_EVENT_ID]
"
exit 1
fi


#################
#  MAIN SCRIPT  #
#################

# Capture current camera view
curl -G -s -o $ZM_EVENTS_DIR/camera.${ZM_CAMERA_ID}.jpg $ZM_WATCH_URL

# Telegram
# ---------
# Source Telegram credentials
. $TELEGRAM_CREDENTIALS_CONFIG
# SendMesage
$TELEGRAM_SCRIPT SendMessage "$NOTIFICATION_SUBJECT $NOTIFICATION_MESSAGE. Attached is a snapshot ..."
# SendPhoto
$TELEGRAM_SCRIPT SendImageDisk  $ZM_EVENTS_DIR/camera.$ZM_CAMERA_ID.jpg


# Send Email
# -----------
$EMAIL_SCRIPT $EMAIL_NOTIFICATION_ADDRESS "$NOTIFICATION_SUBJECT" "$NOTIFICATION_MESSAGE" "$ZM_EVENTS_DIR/camera.${ZM_CAMERA_ID}.jpg"


# OSD
# ---
$OSD_SCRIPT -m "$NOTIFICATION_MESSAGE"
