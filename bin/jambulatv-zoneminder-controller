#!/bin/sh
# This is a general purpose script used in interacting with ZoneMinder
# API from the command line
# 
# Jambula Labs @copyright 2019-2020 All rights reserved

# Variables
PROJECT_NAME=JambulaTV
PROJECT_SYSTEM_CONF_DIR=/etc/$PROJECT_NAME
PROJECT_FUNCTIONS_FILE=$PROJECT_SYSTEM_CONF_DIR/functions

# Source install functions
. $PROJECT_FUNCTIONS_FILE

ZM_ACTION=$1
ZM_CAMERA_ID=$2



###############
#  FUNCTIONS  #
###############

zm_camera_function () {
ZM_CAMERA_FUNCTION=$1
# Change state of specified monitor
$CURL_CMD $CURL_OPTS -b $CURL_COOKIE_JAR_FILE \
	-d "Monitor[Function]=$ZM_CAMERA_FUNCTION" \
		$ZONEMINDER_API_URL/monitors/$ZM_CAMERA_ID.json
}

zm_alarm_arm () {
# Change function of specified monitor to 'Modect'
zm_camera_function Modect
#
# Arm the specified camera
$CURL_CMD $CURL_OPTS -b $CURL_COOKIE_JAR_FILE \
	$ZONEMINDER_API_URL/monitors/alarm/id:$ZM_CAMERA_ID/command:on.json
}

zm_alarm_disarm () {
# Change function of specified monitor to 'Monitor'
zm_camera_function Monitor
#
# Disarm the specified camera
$CURL_CMD $CURL_OPTS -b $CURL_COOKIE_JAR_FILE \
	$ZONEMINDER_API_URL/monitors/alarm/id:$ZM_CAMERA_ID/command:off.json
}

zm_alarm_status () {
$CURL_CMD $CURL_OPTS -b $CURL_COOKIE_JAR_FILE \
	$ZONEMINDER_API_URL/monitors/alarm/id:$ZM_CAMERA_ID/command:status.json
}



#################
#  MAIN SCRIPT  #
#################

# Login
zoneminder_login_using_api


case $ZM_ACTION in

arm)
# Arm the alarm for specified monitor
zm_alarm_arm
;;

disarm)
# Diasarm the alarm for specified monitor
zm_alarm_disarm
;;

status)
# Status of the alarm for specified monitor
zm_alarm_status
;;

capture)
# Arm alarm
$0 arm $ZM_CAMERA_ID

# Wait a bit
sleep 45

# Disarm alarm
$0 disarm $ZM_CAMERA_ID
;;

esac


# Logout
zoneminder_logout_using_api
