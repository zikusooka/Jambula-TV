#!/bin/sh
# This script starts up an Internet stream
#
# Jambula Labs @copyright 2020-2021 All rights reserved

# Variables
PROJECT_NAME=JambulaTV
PROJECT_SYSTEM_CONF_DIR=/etc/$PROJECT_NAME
PROJECT_FUNCTIONS_FILE=$PROJECT_SYSTEM_CONF_DIR/functions

# Source install functions
. $PROJECT_FUNCTIONS_FILE
#
# Source global settings
. $PROJECT_GLOBAL_SETTINGS_FILE

FFMPEG_CMD=/usr/bin/ffmpeg
VLC_CMD=/usr/bin/cvlc
MPLAYER_CMD=/usr/bin/mplayer
MPC_CMD=/usr/bin/mpc
MPD_LOCAL_PORT=$MPD_PORT

WEBRADIO_STREAMER_NUMBER_OF_ARGS=$#
WEBRADIO_STREAMER_TASK=$1
WEBRADIO_STREAMER_STATION=$(/bin/echo "$2" | sed -e "s/[^0-9. ]*//g" -e  "s/ \+/ /g")
WEBRADIO_STREAMER_CLIENT_LOCATION=${@:$WEBRADIO_STREAMER_NUMBER_OF_ARGS}



###############
#  FUNCTIONS  #
###############
usage_all () {
clear
cat <<EOF
Usage: ./$(basename $0) [start|stop|restart|playing] [WEB_RADIO_STATION_ID] [local (Optional)]

EOF
exit 1
}

usage_start () {
if [ "x$WEBRADIO_STREAMER_STATION" = "x" ];
then
clear
less <<EOF
Usage: ./$(basename $0) $WEBRADIO_STREAMER_TASK [WEB_RADIO_STATION_ID e.g. 1] [local (Optional)]

***************************************
Online Radio Station IDs
***************************************
  1  SmoothJazz.com (Jazz)
  2  Jazz 24 (Jazz)
  3  Radio Swiss Jazz
  4  K-Love (Christian)
  5  Family Life (Christian)
  6  23 Indie Street (Indie)
  7  Indie 88 - Toronto, Canda (Indie)
  8  Indie 102.3 - Denver, CO (Indie)
  9  SomaFM (Indie)
 10  KEXP (Alternative)
 11  ALT 98.7 -LA (Alternative)
 12  WDAV - Davidson College, NC (Classical)
 13  KEAN 105 (Country)
 14  Hot 108 (Hip Hop)
 15  NBSRadio (Party)
 16  Radio Santa Claus (Christmas)
 17  Relax (Jazz)
 18  Relax (Latino)
 19  Relax (Life)
 20  Relax (Gold)
 21  Relax (Nature)
 22  Radio Swiss Classic
 23  Radio Swiss Classique
 24  The Loop (Classic Rock)
 25  Black Gospel Radio (Gospel)
 26  WFMV - 95.3 FM (Gospel)
 27  Gospel Highway 11 (Gospel)
 28  WGOK Gospel 900 (Gospel)
 29  1.FM ReggaeTrade (Reggae)
 30  Reggae 141 (Reggae)
 31  Sun City 104.9 FM (Reggae)
 32  UFDV Radio (Reggae)
 33  FM Jamaica Radio (Reggae)
 34  NPR (News)
 35  BBC World Service (News)
 36  KFM (Uganda)
 37  Radio One (Uganda)
 38  Sanyu FM (Uganda)
 39  Capital FM (Uganda)
 40  Next Radio (Uganda)
 41  Simba FM (Uganda)
 42  Beat FM (Uganda)
 43  CBS Radio (Uganda)
 44  Power FM (Uganda)
 45  Impact FM (Uganda)
EOF
exit 1
fi
}

get_webradio_url () {
case $WEBRADIO_STREAMER_STATION in
1)
# Smooth Jazz (Jazz)
WEBRADIO_STREAMER_URL=https://smoothjazz.cdnstream1.com/2585_128.mp3
#WEBRADIO_STREAMER_URL=http://sj64.hnux.com
;;

2)
# Jazz24 (Jazz)
WEBRADIO_STREAMER_URL="https://live.wostreaming.net/direct/ppm-jazz24mp3-ibc1"
#
# 128k MP3
# https://live.wostreaming.net/direct/ppm-jazz24mp3-ibc1
# 256k AAC
# https://live.wostreaming.net/direct/ppm-jazz24aac256-ibc1
# 64k AAC
# https://live.wostreaming.net/direct/ppm-jazz24aac-ibc1
# 48k AAC 
# https://live.wostreaming.net/direct/ppm-jazz24aac48-ibc1
;;

3) 
# Radio Swiss Jazz (Jazz)
WEBRADIO_STREAMER_URL="http://stream.srg-ssr.ch:80/m/rsj/aacp_96"
;;

4)
# K-Love (Christian)
WEBRADIO_STREAMER_URL="https://maestro.emfcdn.com/stream_for/k-love/tunein/aac"
;;

5)
# Family Life Radio (Christian)
WEBRADIO_STREAMER_URL="http://icecast.streammyflr.org:8080/FLRstream"
;;

6)
# 23 Indie Street (Indie)
WEBRADIO_STREAMER_URL="https://streamingv2.shoutcast.com/23-indie-street"
;;

7)
# Indie 88 - Toronto, Canda (Indie)
WEBRADIO_STREAMER_URL="http://cob-ais.leanstream.co/CINDFM"
;;

8) 
# Indie 102.3 - Denver, CO (Indie)
WEBRADIO_STREAMER_URL="https://stream1.cprnetwork.org/cpr3_lo"
;;

9)
# SomaFM (Indie)
WEBRADIO_STREAMER_URL="http://ice1.somafm.com/indiepop-128-mp3"
;;

10)
# KEXP (Alternative)
WEBRADIO_STREAMER_URL="https://kexp-mp3-128.streamguys1.com/kexp128.mp3"
;;

11) 
# ALT 98.7 -LA (Alternative)
WEBRADIO_STREAMER_URL="http://stream.revma.ihrhls.com/zc201"
;;

12)
# WDAV - Davidson College, NC (Classical)
WEBRADIO_STREAMER_URL="http://audio-mp3.ibiblio.org:8000/concierto"
;;

13)
# KEAN 105 (Country)
WEBRADIO_STREAMER_URL="http://54.82.83.208/townsquare-keanfmaac-ibc3"
;;

14)
# Hot 108 (Hip Hop)
WEBRADIO_STREAMER_URL="http://listen.hot108.com/hot108"
;;

15)
# NBSRadio (House/Party/Beats)
WEBRADIO_STREAMER_URL="http://live.nsbradio.co.uk:8904/"
;;

16)
# Radio Santa Claus (Christmas)
WEBRADIO_STREAMER_URL="https://streaming.radiostreamlive.com/radiosantaclaus_devices"
;;

17)
# Relax (Jazz)
WEBRADIO_STREAMER_URL="http://ic4.101.ru:8000/c19_2"
;;

18)
# Relax (Latino)
WEBRADIO_STREAMER_URL="http://ic4.101.ru:8000/c19_3"
;;

19)
# Relax (Life)
WEBRADIO_STREAMER_URL="http://ic4.101.ru:8000/c19_5"
;;

20)
# Relax (Gold)
WEBRADIO_STREAMER_URL="http://ic4.101.ru:8000/c19_4"
;;

21)
# Relax (Nature)
WEBRADIO_STREAMER_URL="http://ic4.101.ru:8000/c19_1"
;;

22)
# Radio Swiss Classic (Classical)
WEBRADIO_STREAMER_URL="http://stream.srg-ssr.ch:80/m/rsc_de/aacp_96"
;;

23)
# Radio Swiss Classique (Classical)
WEBRADIO_STREAMER_URL="http://stream.srg-ssr.ch/m/rsc_fr/mp3_128"
;;

24)
# WLUP-FM - The Loop 97.9 FM (Classic Rock)
WEBRADIO_STREAMER_URL="http://208.92.55.133:3690/WLUPFM_SC"
;;

25)
# Black Gospel Radio (Gospel)
WEBRADIO_STREAMER_URL="http://ice64.securenetsystems.net/BGRLIVE"
;;

26)
# WFMV - 95.3 FM (Gospel)
WEBRADIO_STREAMER_URL="http://ice8.securenetsystems.net/WFMV"
;;

27)
# WNAP - Gospel Highway 11 1110 AM (Gospel)
WEBRADIO_STREAMER_URL="http://ice23.securenetsystems.net/WNAP"
;;

28)
# WGOK Gospel 900 (Gospel)
WEBRADIO_STREAMER_URL="http://17013.live.streamtheworld.com/WGOKAM.mp3"
;;

29)
# 1.FM ReggaeTrade (Reggae)
WEBRADIO_STREAMER_URL="http://strm112.1.fm/reggae_mobile_mp3"
;;

30)
# Reggae 141 (Reggae)
WEBRADIO_STREAMER_URL="http://hestia2.cdnstream.com/1301_128"
;;

31)
# Sun City 104.9 FM (Reggae)
WEBRADIO_STREAMER_URL="http://streams.suncityradio.fm:8000"
;;

32)
# UFDV Radio (Reggae)
WEBRADIO_STREAMER_URL="http://cp3.serverse.com:7059/stream"
;;

33)
# FM Jamaica Radio (Reggae)
WEBRADIO_STREAMER_URL="http://us5.internet-radio.com:8487"
;;

34)
# NPR - National Public Radio (News)
WEBRADIO_STREAMER_URL="https://npr-ice.streamguys1.com/live.mp3"
;;

35)
# BBC World Service (News)
WEBRADIO_STREAMER_URL="https://stream.live.vc.bbcmedia.co.uk/bbc_world_service"
;;

36) 
# KFM (Uganda)
WEBRADIO_STREAMER_URL="http://81.199.17.51:8000/stream"
;;

37)
# Radio One (Uganda)
WEBRADIO_STREAMER_URL="http://162.244.80.52:8740/stream/1"
;;

38)
# Sanyu FM (Uganda)
WEBRADIO_STREAMER_URL="http://s44.myradiostream.com:8138"
;;

39)
# Capital FM (Uganda)
WEBRADIO_STREAMER_URL="http://144.217.203.226:8316/stream/1"
;;

40)
# Next Radio (Uganda)
WEBRADIO_STREAMER_URL="http://streams.radio.co/see104bedb/listen"
;;

41)
# Simba FM (Uganda)
WEBRADIO_STREAMER_URL="http://www.radiosimba.ug:8000/stream"
;;

42)
# Beat FM (Uganda)
WEBRADIO_STREAMER_URL="http://5230.cloudrad.io:8354"
;;

43)
# CBS Radio (Uganda)
WEBRADIO_STREAMER_URL="http://41.202.239.38:88/broadwavehigh.mp3"
;;

44) 
# Power FM (Uganda)
WEBRADIO_STREAMER_URL=""
;;

45)
# Impact FM (Uganda)
WEBRADIO_STREAMER_URL=""
;;

*)
exit 1
;;
esac
}

mpd_check_status () {
# Check status of MPD server
$MPC_CMD -q -h localhost -p $MPD_LOCAL_PORT status > /dev/null 2>&1
MPC_EXIT_STATUS=$?
# Check if anything is playing
MPC_CURRENTLY_PLAYING=$($MPC_CMD -q -h localhost -p $MPD_LOCAL_PORT current)
}

mpd_current_playlist_stop () {
# Stop any running playlist, so we take over
$MPC_CMD -q -h localhost -p $MPD_LOCAL_PORT stop
# Clear previous added playlist
$MPC_CMD -q -h localhost -p $MPD_LOCAL_PORT clear
}

mpd_now_playing () {
# See if song filename ends with a known music extension i.e. is locally saved
$MPC_CMD -h localhost -p $MPD_LOCAL_PORT playlist | grep -i -e '.m4a$' -e '.wma$' -e '.ogg$' -e '.wav$' -e '.mp3$' -e '.mp4$' > /dev/null 2>&1
SONG_IS_STORED_LOCALLY=$?
#
# Get title and artist
if [[ "$SONG_IS_STORED_LOCALLY" = "0" ]];
then
NAME_OF_STATION=$($MPC_CMD -h localhost -p $MPD_LOCAL_PORT current | sed 's: Radio Edit::g' | sed 's:(Lyrics Video)::g' | sed 's:(Official video)::g' | sed 's:\.mp3::g' | sed 's:\.wmv::g' | cut -d '/' -f2- | awk -F'[.|-]' {'print $1'} | sed 's:[_|\.|/]: :g' | sed 's:^[_|-]::g' | sed 's:[_|-]$::g' | sed 's:^ ::g' | sed 's: $::g' | sed 's:^  ::g' | sed 's:  $::g')
NAME_OF_SONG_ARTIST=$($MPC_CMD -h localhost -p $MPD_LOCAL_PORT current | sed -r ':a; s/\b([[:alnum:]]+)\b(.*)\b\1\b/\1\2/g; ta; s/(, )+/, /g; s/, *$//' | cut -d'/' -f2- | sed 's: Radio Edit::g' | sed 's:(Lyrics Video)::g' | sed 's:(Official video)::g' | sed 's:\.mp3::g' | sed 's:\.wmv::g' | rev | awk -F' [:|.|-]' '{print $1 $2 $3 $4}' | rev | sed 's: - :#:g' | cut -d"#" -f1- | rev | cut -d '#' -f1-2 | rev | sed 's:#: - :g' | sed 's:[_|\.|/]: :g' | sed "s:$NAME_OF_STATION::g" | sed 's:^[_|-]::g' | sed 's:[_|-]$::g' | sed 's:^ ::g' | sed 's: $::g' | sed 's:^  ::g' | sed 's:  $::g')
GENRE=$($MPC_CMD -h localhost -p $MPD_LOCAL_PORT -f %file% current | awk -F'/' '{print $1}') 

else
NAME_OF_STATION=$($MPC_CMD -h localhost -p $MPD_LOCAL_PORT -f '%artist%' current)
[[ "x$NAME_OF_STATION" = "x" ]] && \
NAME_OF_STATION=$($MPC_CMD -h localhost -p $MPD_LOCAL_PORT current -f '%name%' | sed 's:^/::')
#
NAME_OF_SONG_ARTIST=$($MPC_CMD -h localhost -p $MPD_LOCAL_PORT -f '%title%' current | rev | awk -F' :' '{print $1}' | rev | sed 's: - :#:g' | cut -d"#" -f1- | rev | cut -d '#' -f1-2 | rev | sed 's:^ ::g' | sed 's:[(|)]::g' | sed 's: Radio Edit::g' | sed 's:#: - :g' | sed 's/text=//' | awk -F'song_spot=' '{print $1}' | sed 's:"::g')
GENRE=$($MPC_CMD -h localhost -p $MPD_LOCAL_PORT -f '%genre%' current)
fi
}

internet_radio_via_mpd_start () {
# Stop and clear current playlist
mpd_current_playlist_stop
# Add Internet Radio feed
$MPC_CMD -q -h localhost -p $MPD_LOCAL_PORT add $WEBRADIO_STREAMER_URL
# Play Internet Radio feed
$MPC_CMD -q -h localhost -p $MPD_LOCAL_PORT play
}

internet_radio_via_mpd_stop () {
# Stop and clear current playlist
mpd_current_playlist_stop
}

remove_previous_log_file () {
# Remove previous log file
[[ -e $WEBRADIO_STREAMER_LOG_FILE ]] || sudo rm -f $WEBRADIO_STREAMER_LOG_FILE 
}

stream_local () {
# Pre stream start tasks
remove_previous_log_file
#
case $WEBRADIO_STREAMER_CLIENT_LOCATION in
# Play locally if requested
local)
# Check status of MPD server
mpd_check_status
#
# Stream Internet Radio over mpd if server is running
if [[ "$MPC_EXIT_STATUS" = "0" ]];
then
internet_radio_via_mpd_start

else
# Stream using CLI tool i.e. mplayer
PULSEAUDIO_USER=$MULTIMEDIA_USER && \
	$MPLAYER_CMD -noconsolecontrols -ao $AUDIO_OUTPUT_DRIVER::0 -novideo -nocache -nolirc -prefer-ipv4 -loop 0 $WEBRADIO_STREAMER_URL > $WEBRADIO_STREAMER_LOG_FILE 2>&1 &
fi
;;
esac
}

stream_start () {
# Usage
usage_start
#
# Remove previous log file
remove_previous_log_file
#
# Get web radio station URL
get_webradio_url
#
# Check status of MPD server
mpd_check_status
#
# Stream Internet Radio over mpd if server is running
if [[ "$MPC_EXIT_STATUS" = "0" ]];
then
internet_radio_via_mpd_start

else
# Stream using CLI tool i.e. mplayer
PULSEAUDIO_USER=$MULTIMEDIA_USER && \
	$MPLAYER_CMD -noconsolecontrols -ao $AUDIO_OUTPUT_DRIVER::0 -novideo -nocache -nolirc -prefer-ipv4 -loop 0 $WEBRADIO_STREAMER_URL > $WEBRADIO_STREAMER_LOG_FILE 2>&1 &
fi
#
# Pause a bit to allow radio to settle
sleep 3
#
# Add process ID (PID) numbers to temp file
MPLAYER_PID=$(ps auxw | grep -Ev grep | grep mplayer | grep -E "(http|https|rtmp|rtsp|m3u|m3u8|pls)" | awk {'print $2'})
VLC_PID=$(ps auxw | grep -Ev grep | grep vlc | grep -E "(http|https|rtmp|rtsp|m3u|m3u8|pls)" | awk {'print $2'})
FFMPEG_PID=$(ps auxw | grep -Ev grep | grep ffmpeg | grep "f s16le -ac 1 -i pipe:0 -acodec libmp3lame -ab 128k -f mpegts" | awk {'print $2'})
#
cat > $WEBRADIO_STREAMER_PID_FILE <<EOF
$MPLAYER_PID $VLC_PID $FFMPEG_PID
EOF
#
# Stream locally if user requested
#stream_local
}

stream_stop () {
# Check status of MPD server
mpd_check_status
#
# Stream Internet Radio over mpd if server is running
[[ "$MPC_EXIT_STATUS" = "0" ]] && internet_radio_via_mpd_stop
#
# Kill streamer processes
[[ -e $WEBRADIO_STREAMER_PID_FILE ]] && sudo kill -15 $(cat $WEBRADIO_STREAMER_PID_FILE) > /dev/null 2>&1 &
# Remove PIDs file
if [[ -e $WEBRADIO_STREAMER_PID_FILE ]];
then
sudo rm -f $WEBRADIO_STREAMER_PID_FILE
fi
# Remove previous log file
remove_previous_log_file
}

stream_restart () {
usage_start
# Stop previous station
$0 stop
# Pause a bit to allow radio to settle
sleep 3
# Stream new station
$0 start $WEBRADIO_STREAMER_STATION $WEBRADIO_STREAMER_CLIENT_LOCATION
#
# Stream locally if user requested
#stream_local
}

stream_now_playing () {
# Get age of log file
AGE_OF_WEBRADIO_STREAMER_LOG_FILE=$(date -d "now - $(stat -c "%Y" $WEBRADIO_STREAMER_LOG_FILE) seconds" +%s)
# Only show 'now playing' if the age of log file is less than 1 minute
if [[ "$AGE_OF_WEBRADIO_STREAMER_LOG_FILE" -lt "60" ]];
then
NAME_OF_STATION=$(/usr/bin/awk '/Name   : / {print $3}' $WEBRADIO_STREAMER_LOG_FILE | /usr/bin/head -1 | /usr/bin/sort -u)
NAME_OF_SONG_ARTIST=$(/usr/bin/grep -a -oP "(?<=ICY Info: StreamTitle=').+?(?=';)" $WEBRADIO_STREAMER_LOG_FILE | /usr/bin/tail -1)
fi
}

playing_now () {
# Check status of MPD server
mpd_check_status
#
# Fetch 'Now Playing' info if MPD server is running
if [[ "$MPC_EXIT_STATUS" = "0" ]];
then
mpd_now_playing

else
# Get 'Now Playing' info 
stream_now_playing
fi

# Quit if nothing is playing
[[ "x$MPC_CURRENTLY_PLAYING" = "x" ]] && exit 0

# Print name of station, song, and artist if found
if [[ "$NAME_OF_STATION" = "$NAME_OF_SONG_ARTIST" && "x$NAME_OF_SONG_ARTIST" != "x" ]] || [[ "x$NAME_OF_STATION" = "x" && "x$NAME_OF_SONG_ARTIST" != "x" ]];
then
[[ "x$GENRE" != "x" ]] && echo "$NAME_OF_SONG_ARTIST [$GENRE]"
[[ "x$GENRE" = "x" ]] && echo "$NAME_OF_SONG_ARTIST"

elif [[ "x$NAME_OF_STATION" != "x" && "x$NAME_OF_SONG_ARTIST" != "x" ]];
then
[[ "x$GENRE" != "x" ]] && echo "$NAME_OF_STATION - $NAME_OF_SONG_ARTIST [$GENRE]"
[[ "x$GENRE" = "x" ]] && echo "$NAME_OF_STATION - $NAME_OF_SONG_ARTIST"

else
[[ "x$GENRE" != "x" ]] && echo "$NAME_OF_STATION [$GENRE]"
[[ "x$GENRE" = "x" ]] && echo "$NAME_OF_STATION"
fi
}



#################
#  MAIN SCRIPT  #
#################

trap stream_stop SIGTERM

case $WEBRADIO_STREAMER_TASK in

start)
stream_start
;;

stop)
stream_stop
;;

restart)
stream_restart
;;

playing)
playing_now
;;

*)
usage_all
;;

esac
