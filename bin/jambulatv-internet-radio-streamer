#!/bin/sh
# This script starts up an Internet stream
#
# Jambula Labs @copyright 2022-2023 All rights reserved

# Variables
PROJECT_NAME=JambulaTV
PROJECT_SYSTEM_CONF_DIR=/etc/$PROJECT_NAME
PROJECT_FUNCTIONS_FILE=$PROJECT_SYSTEM_CONF_DIR/functions

# Source install functions
. $PROJECT_FUNCTIONS_FILE
#
# Source global settings
. $PROJECT_GLOBAL_SETTINGS_FILE

FFMPEG_CMD=/usr/bin/ffmpeg
VLC_CMD=/usr/bin/cvlc
MPLAYER_CMD=/usr/bin/mplayer

WEBRADIO_STREAMER_NUMBER_OF_ARGS=$#
WEBRADIO_STREAMER_TASK=$1
WEBRADIO_STREAMER_STATION=$(/bin/echo "$2" | sed -e "s/[^0-9. ]*//g" -e  "s/ \+/ /g")
WEBRADIO_STREAMER_CLIENT_LOCATION=${@:$WEBRADIO_STREAMER_NUMBER_OF_ARGS}



###############
#  FUNCTIONS  #
###############
usage_all () {
clear
cat <<EOF
Usage: ./$(basename $0) [start|stop|restart] [WEB_RADIO_STATION_ID] [local (Optional)]

EOF
exit 1
}

usage_start () {
if [ "x$WEBRADIO_STREAMER_STATION" = "x" ];
then
clear
less <<EOF
Usage: ./$(basename $0) $WEBRADIO_STREAMER_TASK [WEB_RADIO_STATION_ID e.g. 1] [local (Optional)]

***************************************
Online Radio Station IDs
***************************************
  1  SmoothJazz.com (Jazz)
  2  WBGO 88.3 - Newark, NJ (Jazz)
  3  Jazz 24 (Jazz)
  4  Radio Swiss Jazz
  5  K-Love (Christian)
  6  Family Life (Christian)
  7  23 Indie Street (Indie)
  8  Indie 88 - Toronto, Canada (Indie)
  9  Indie 102.3 - Denver, CO (Indie)
 10  SomaFM (Indie)
 11  KEXP (Alternative)
 12  ALT 98.7 - LA (Alternative)
 13  WDAV - Davidson College, NC (Classical)
 14  KEAN 105 (Country)
 15  Hot 108 (Hip Hop)
 16  NBSRadio (Party)
 17  Radio Santa Claus (Christmas)
 18  Relax (Jazz)
 19  Relax (Latino)
 20  Relax (Life)
 21  Relax (Gold)
 22  Relax (Nature)
 23  Radio Swiss Classic
 24  Radio Swiss Classique
 25  The Loop (Classic Rock)
 26  Black Gospel Radio (Gospel)
 27  WFMV - 95.3 FM (Gospel)
 28  Gospel Highway 11 (Gospel)
 29  WGOK Gospel 900 (Gospel)
 30  1.FM ReggaeTrade (Reggae)
 31  Reggae 141 (Reggae)
 32  Sun City 104.9 FM (Reggae)
 33  UFDV Radio (Reggae)
 34  FM Jamaica Radio (Reggae)
 35  NPR (News)
 36  BBC World Service (News)
 37  KFM (Uganda)
 38  Radio One (Uganda)
 39  Sanyu FM (Uganda)
 40  Capital FM (Uganda)
 41  Next Radio (Uganda)
 42  Simba FM (Uganda)
 43  Beat FM (Uganda)
 44  CBS Radio (Uganda)
 45  Power FM (Uganda)
 46  Impact FM (Uganda)
EOF
exit 1
fi
}

get_webradio_url () {
case $WEBRADIO_STREAMER_STATION in
1)
# Smooth Jazz (Jazz)
WEBRADIO_STREAMER_URL="https://smoothjazz.cdnstream1.com/2585_128.mp3"
;;

2)
# WBGO (Jazz)
WEBRADIO_STREAMER_URL="https://wbgo.streamguys.net/wbgo-64k.aac"
;;

3)
# Jazz24 (Jazz)
WEBRADIO_STREAMER_URL="https://live.wostreaming.net/direct/ppm-jazz24mp3-ibc1"
#
# 128k MP3
# https://live.wostreaming.net/direct/ppm-jazz24mp3-ibc1
# 256k AAC
# https://live.wostreaming.net/direct/ppm-jazz24aac256-ibc1
# 64k AAC
# https://live.wostreaming.net/direct/ppm-jazz24aac-ibc1
# 48k AAC 
# https://live.wostreaming.net/direct/ppm-jazz24aac48-ibc1
;;

4) 
# Radio Swiss Jazz (Jazz)
WEBRADIO_STREAMER_URL="http://stream.srg-ssr.ch:80/m/rsj/aacp_96"
;;

5)
# K-Love (Christian)
WEBRADIO_STREAMER_URL="https://maestro.emfcdn.com/stream_for/k-love/tunein/aac"
;;

6)
# Family Life Radio (Christian)
WEBRADIO_STREAMER_URL="http://icecast.streammyflr.org/FLRstream"
;;

7)
# 23 Indie Street (Indie)
WEBRADIO_STREAMER_URL="https://streamingv2.shoutcast.com/23-indie-street"
;;

8)
# Indie 88 - Toronto, Canda (Indie)
WEBRADIO_STREAMER_URL="http://cob-ais.leanstream.co/CINDFM"
;;

9) 
# Indie 102.3 - Denver, CO (Indie)
WEBRADIO_STREAMER_URL="https://stream1.cprnetwork.org/cpr3_lo"
;;

10)
# SomaFM (Indie)
WEBRADIO_STREAMER_URL="http://ice1.somafm.com/indiepop-128-mp3"
;;

11)
# KEXP (Alternative)
WEBRADIO_STREAMER_URL="https://kexp-mp3-128.streamguys1.com/kexp128.mp3"
;;

12) 
# ALT 98.7 -LA (Alternative)
WEBRADIO_STREAMER_URL="http://stream.revma.ihrhls.com/zc201"
;;

13)
# WDAV - Davidson College, NC (Classical)
WEBRADIO_STREAMER_URL="http://audio-mp3.ibiblio.org:8000/concierto"
;;

14)
# KEAN 105 (Country)
WEBRADIO_STREAMER_URL="http://live.wostreaming.net/direct/townsquare-keanfmaac-ibc3"
;;

15)
# Hot 108 (Hip Hop)
WEBRADIO_STREAMER_URL="http://hot108jamz.hot108.com:4040"
;;

16)
# NBSRadio (House/Party/Beats)
WEBRADIO_STREAMER_URL="http://live.nsbradio.co.uk:8904/"
;;

17)
# Radio Santa Claus (Christmas)
WEBRADIO_STREAMER_URL="https://streaming.radiostreamlive.com/radiosantaclaus_devices"
;;

18)
# Relax (Jazz)
WEBRADIO_STREAMER_URL="http://ic4.101.ru:8000/c19_2"
;;

19)
# Relax (Latino)
WEBRADIO_STREAMER_URL="http://ic4.101.ru:8000/c19_3"
;;

20)
# Relax (Life)
WEBRADIO_STREAMER_URL="http://ic4.101.ru:8000/c19_5"
;;

21)
# Relax (Gold)
WEBRADIO_STREAMER_URL="http://ic4.101.ru:8000/c19_4"
;;

22)
# Relax (Nature)
WEBRADIO_STREAMER_URL="http://ic4.101.ru:8000/c19_1"
;;

23)
# Radio Swiss Classic (Classical)
WEBRADIO_STREAMER_URL="http://stream.srg-ssr.ch:80/m/rsc_de/aacp_96"
;;

24)
# Radio Swiss Classique (Classical)
WEBRADIO_STREAMER_URL="http://stream.srg-ssr.ch/m/rsc_fr/mp3_128"
;;

25)
# WLUP-FM - The Loop 97.9 FM (Classic Rock)
WEBRADIO_STREAMER_URL="http://208.92.55.133:3690/WLUPFM_SC"
;;

26)
# Black Gospel Radio (Gospel)
WEBRADIO_STREAMER_URL="http://ice64.securenetsystems.net/BGRLIVE"
;;

27)
# WFMV - 95.3 FM (Gospel)
WEBRADIO_STREAMER_URL="http://ice8.securenetsystems.net/WFMV"
;;

28)
# WNAP - Gospel Highway 11 1110 AM (Gospel)
WEBRADIO_STREAMER_URL="http://ice23.securenetsystems.net/WNAP"
;;

29)
# WGOK Gospel 900 (Gospel)
WEBRADIO_STREAMER_URL="http://17013.live.streamtheworld.com/WGOKAM.mp3"
;;

30)
# 1.FM ReggaeTrade (Reggae)
WEBRADIO_STREAMER_URL="http://strm112.1.fm/reggae_mobile_mp3"
;;

31)
# Reggae 141 (Reggae)
WEBRADIO_STREAMER_URL="http://hestia2.cdnstream.com/1301_128"
;;

32)
# Sun City 104.9 FM (Reggae)
WEBRADIO_STREAMER_URL="http://streams.suncityradio.fm:8000"
;;

33)
# UFDV Radio (Reggae)
WEBRADIO_STREAMER_URL="http://cp3.serverse.com:7059/stream"
;;

34)
# FM Jamaica Radio (Reggae)
WEBRADIO_STREAMER_URL="http://us5.internet-radio.com:8487"
;;

35)
# NPR - National Public Radio (News)
WEBRADIO_STREAMER_URL="https://npr-ice.streamguys1.com/live.mp3"
;;

36)
# BBC World Service (News)
WEBRADIO_STREAMER_URL="https://stream.live.vc.bbcmedia.co.uk/bbc_world_service"
;;

37) 
# KFM (Uganda)
WEBRADIO_STREAMER_URL="http://81.199.17.51:8000/stream"
;;

38)
# Radio One (Uganda)
WEBRADIO_STREAMER_URL="http://162.244.80.52:8740/stream/1"
;;

39)
# Sanyu FM (Uganda)
WEBRADIO_STREAMER_URL="http://s44.myradiostream.com:8138"
;;

40)
# Capital FM (Uganda)
WEBRADIO_STREAMER_URL="http://144.217.203.226:8316/stream/1"
;;

41)
# Next Radio (Uganda)
WEBRADIO_STREAMER_URL="http://streams.radio.co/see104bedb/listen"
;;

42)
# Simba FM (Uganda)
WEBRADIO_STREAMER_URL="http://www.radiosimba.ug:8000/stream"
;;

43)
# Beat FM (Uganda)
WEBRADIO_STREAMER_URL="http://5230.cloudrad.io:8354"
;;

44)
# CBS Radio (Uganda)
WEBRADIO_STREAMER_URL="http://41.202.239.38:88/broadwavehigh.mp3"
;;

45) 
# Power FM (Uganda)
WEBRADIO_STREAMER_URL=""
;;

46)
# Impact FM (Uganda)
WEBRADIO_STREAMER_URL=""
;;

*)
exit 1
;;
esac
}

mpd_check_status () {
# Check status of MPD server
$MPD_CLIENT_CMD $MPD_CLIENT_OPTS -h $MPD_SERVER_IP -p $MPD_SERVER_PORT status > /dev/null 2>&1
MPC_EXIT_STATUS=$?
# Check if anything is playing
MPC_CURRENTLY_PLAYING=$($MPD_CLIENT_CMD $MPD_CLIENT_OPTS -h $MPD_SERVER_IP -p $MPD_SERVER_PORT current)
}

mpd_current_playlist_stop () {
# Stop any running playlist, so we take over
$MPD_CLIENT_CMD $MPD_CLIENT_OPTS -h $MPD_SERVER_IP -p $MPD_SERVER_PORT stop
# Clear previous added playlist
$MPD_CLIENT_CMD $MPD_CLIENT_OPTS -h $MPD_SERVER_IP -p $MPD_SERVER_PORT clear
}

internet_radio_via_mpd_start () {
# Stop and clear current playlist
mpd_current_playlist_stop
# Add Internet Radio feed
$MPD_CLIENT_CMD $MPD_CLIENT_OPTS -h $MPD_SERVER_IP -p $MPD_SERVER_PORT add $WEBRADIO_STREAMER_URL
# Play Internet Radio feed
$MPD_CLIENT_CMD $MPD_CLIENT_OPTS -h $MPD_SERVER_IP -p $MPD_SERVER_PORT play
}

internet_radio_via_mpd_stop () {
# Stop and clear current playlist
mpd_current_playlist_stop
}

remove_previous_log_file () {
# Remove previous log file
[[ -e $WEBRADIO_STREAMER_LOG_FILE ]] || sudo rm -f $WEBRADIO_STREAMER_LOG_FILE 
}

stream_local () {
# Pre stream start tasks
remove_previous_log_file
#
case $WEBRADIO_STREAMER_CLIENT_LOCATION in
# Play locally if requested
local)
# Check status of MPD server
mpd_check_status
#
# Stream Internet Radio over mpd if server is running
if [[ "$MPC_EXIT_STATUS" = "0" ]];
then
internet_radio_via_mpd_start

else
# Stream using CLI tool i.e. mplayer
PULSEAUDIO_USER=$MULTIMEDIA_USER && \
	$MPLAYER_CMD -noconsolecontrols -ao $AUDIO_OUTPUT_DRIVER::0 -novideo -nocache -nolirc -prefer-ipv4 -loop 0 $WEBRADIO_STREAMER_URL > $WEBRADIO_STREAMER_LOG_FILE 2>&1 &
fi
;;
esac
}

stream_start () {
# Usage
usage_start
#
# Remove previous log file
remove_previous_log_file
#
# Get web radio station URL
get_webradio_url
#
# Check status of MPD server
mpd_check_status
#
# Stream Internet Radio over mpd if server is running
if [[ "$MPC_EXIT_STATUS" = "0" ]];
then
internet_radio_via_mpd_start

else
# Stream using CLI tool i.e. mplayer
PULSEAUDIO_USER=$MULTIMEDIA_USER && \
	$MPLAYER_CMD -noconsolecontrols -ao $AUDIO_OUTPUT_DRIVER::0 -novideo -nocache -nolirc -prefer-ipv4 -loop 0 $WEBRADIO_STREAMER_URL > $WEBRADIO_STREAMER_LOG_FILE 2>&1 &
fi
#
# Pause a bit to allow radio to settle
sleep 3
#
# Add process ID (PID) numbers to temp file
MPLAYER_PID=$(ps auxw | grep -Ev grep | grep mplayer | grep -E "(http|https|rtmp|rtsp|m3u|m3u8|pls)" | awk {'print $2'})
VLC_PID=$(ps auxw | grep -Ev grep | grep vlc | grep -E "(http|https|rtmp|rtsp|m3u|m3u8|pls)" | awk {'print $2'})
FFMPEG_PID=$(ps auxw | grep -Ev grep | grep ffmpeg | grep "f s16le -ac 1 -i pipe:0 -acodec libmp3lame -ab 128k -f mpegts" | awk {'print $2'})
#
cat > $WEBRADIO_STREAMER_PID_FILE <<EOF
$MPLAYER_PID $VLC_PID $FFMPEG_PID
EOF
#
# Stream locally if user requested
#stream_local
}

stream_stop () {
# Check status of MPD server
mpd_check_status
#
# Stream Internet Radio over mpd if server is running
[[ "$MPC_EXIT_STATUS" = "0" ]] && internet_radio_via_mpd_stop
#
# Kill streamer processes
[[ -e $WEBRADIO_STREAMER_PID_FILE ]] && sudo kill -15 $(cat $WEBRADIO_STREAMER_PID_FILE) > /dev/null 2>&1 &
# Remove PIDs file
if [[ -e $WEBRADIO_STREAMER_PID_FILE ]];
then
sudo rm -f $WEBRADIO_STREAMER_PID_FILE
fi
# Remove previous log file
remove_previous_log_file
}

stream_restart () {
usage_start
# Stop previous station
$0 stop
# Pause a bit to allow radio to settle
sleep 3
# Stream new station
$0 start $WEBRADIO_STREAMER_STATION $WEBRADIO_STREAMER_CLIENT_LOCATION
#
# Stream locally if user requested
#stream_local
}



#################
#  MAIN SCRIPT  #
#################

trap stream_stop SIGTERM

case $WEBRADIO_STREAMER_TASK in

start)
stream_start
;;

stop)
stream_stop
;;

restart)
stream_restart
;;

*)
usage_all
;;

esac
