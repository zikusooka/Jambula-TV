#!/usr/local/bin/python3
# Display Announcements on JambulaTV Screen
# Jambula Labs @copyright 2018-2019 All rights reserved
#
# Import modules
import json
import http.client
import base64
import sys
import argparse
import os
import subprocess
import time
import threading 
from threading import Timer
import xml.etree.ElementTree as ET
from pyxmpp2.simple import send_message
from pyxmpp2.settings import XMPPSettings
from textwrap import wrap


# Who called this script
PPID = os.getppid()
PID = os.getpid()
CALLER = open('/proc/%d/cmdline' % PPID).read().split('\x00', 1)[1]

# Variables
JAMBULATV_VIRTUAL_TERMINAL = 'tty7'
KODI_GUI_SETTINGS = 'MY_KODI_USER_DATA/guisettings.xml'
ICON = 'MY_KODI_SYSTEM_ADDONS/skin.estouchy/media/DefaultIconInfo.png'
OSDRUNFILE = 'MY_TMPDIR/osd_process_running' 

# Copyright
__author__ = 'Joseph Zikusooka.  Jambula Labs @copyright 2018-2019 All rights reserved'

# Parse arguments/ message
parser = argparse.ArgumentParser(description='Display Announcements on JambulaTV Screen')
parser.add_argument('-m','--message', help='The message you want displayed.  Wrap it in quotes',required=True)
parser.add_argument('-t','--duration', help='How long in milliseconds you want the message displayed',type=int,required=False)
args = parser.parse_args()

MESSAGE = args.message
MESSAGE_WRAPPED = wrap(args.message, 106)

# XMPP credentials
XMPP_TOOL = 'MY_XMPP_TOOL'
XMPP_JID = 'USER_001_XMPP_USERNAME@USER_001_XMPP_HOST'
XMPP_PASSWORD = 'USER_001_XMPP_PASSWORD'
XMPP_RESOURCE = 'USER_001_XMPP_RESOURCE'
XMPP_RECIPIENT = XMPP_JID

# Set duration
if args.duration is None:
    TIME = 35000
else:
    TIME = args.duration

# Get Kodi web server variables
tree = ET.parse(KODI_GUI_SETTINGS)
root = tree.getroot()
for services in root.findall('services'):
    username = services.find('webserverusername').text
    password = services.find('webserverpassword').text
    xbmc_title = services.find('devicename').text
    xbmc_port = services.find('webserverport').text
    xbmc_host='127.0.0.1'



# Functions
# ---------
#
# Quit if active screen console is not running kodi
def quit_if_screen_not_running ():
        status, active_virtual_terminal = subprocess.getstatusoutput("cat /sys/class/tty/tty0/active")
        if active_virtual_terminal != (JAMBULATV_VIRTUAL_TERMINAL):
          sys.exit("Error: JambulaTV is not running on active terminal")

# Wait to run this script if already running
def wait_if_already_running ():
        while os.path.exists(OSDRUNFILE):
          print ("Another OSD process is running, please wait ...")
          time.sleep(10)

# Open, write, close a temporary file to prevent others from calling this script until done
def create_run_file ():
        processfile = open(OSDRUNFILE, 'w')
        processfile.write(CALLER)
        processfile.close()

# Send xmpp message with notice
def send_xmpp_message ():
        subprocess.check_call([XMPP_TOOL, "-q", "-j", XMPP_JID, "-p", XMPP_PASSWORD, "-t", XMPP_RECIPIENT, "-m", "[JambulaTV] OSD Notice: " +MESSAGE])

# Connect to Kodi
def send_json_command(xbmc_host, xbmc_port, method, params=None, id=1, username=username, password=password):
    command = {'jsonrpc': '2.0', 'id': id, 'method': method}
    if params is not None: command['params'] = params
    payload = json.dumps(command, ensure_ascii=False, sort_keys=True)
    payload.encode('utf-8')
    headers = {'Content-Type': 'application/json'}
    if password != '':
        #userpass = base64.encodestring('%s:%s' % (username, password))[:-1] # Python2
        userpass = base64.encodestring(('%s:%s' % (username,password)).encode()).decode().replace('\n', '')
        headers['Authorization'] = 'Basic %s' % userpass
    #conn = httplib.HTTPConnection(xbmc_host, xbmc_port) # Python 2
    conn = http.client.HTTPConnection(xbmc_host, xbmc_port)
    data = None
    try:
        conn.request('POST', '/jsonrpc', payload, headers)
        response = conn.getresponse()
        if response.status == 200: data = json.loads(response.read())['result']
        else: data = 'Response Error'
    except:
        data = 'Connection Error'
    conn.close()
    return data

# De-activate screensaver
def xbmc_poke_screen(xbmc_host, xbmc_port=xbmc_port):
        screenSaverStatus = send_json_command(xbmc_host, xbmc_port, 'XBMC.GetInfoBooleans', params={'booleans':['System.ScreenSaverActive']})
        if screenSaverStatus == {u'System.ScreenSaverActive': True}:
          send_json_command(xbmc_host, xbmc_port, "Input.Select")

# Check if current PID still exists
def check_pid(pid):        
    """ Check For the existence of a unix pid. """
    try:
        os.kill(pid, 0)
    except OSError:
        return False
    else:
        return True

# Display message on screen
def xbmc_osd_message(xbmc_host, xbmc_port=xbmc_port):
    for OSD_STRING in MESSAGE_WRAPPED:
        check_pid (PID)    
        send_json_command(xbmc_host, xbmc_port, 'GUI.ShowNotification', params={'title':xbmc_title, 'message':OSD_STRING, 'displaytime':TIME, 'image':ICON})
        time.sleep(10)



#################
#  MAIN SCRIPT  #
#################

# Pre process tasks
quit_if_screen_not_running()
wait_if_already_running()
create_run_file()

# Poke screen if screensaver is active
xbmc_poke_screen(xbmc_host)

# Display message on screen
xbmc_osd_message(xbmc_host)

# Send XMPP message in background mode
send_xmpp_message ()

# Remove run file created earlier to prevent others from using me
if os.path.exists(OSDRUNFILE):
    os.remove(OSDRUNFILE)

# Exit
sys.exit(0)
