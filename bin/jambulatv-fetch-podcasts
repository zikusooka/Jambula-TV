#!/bin/sh
# Variables
ARIA2_CMD=/usr/bin/aria2c 
ARIA2_OPTIONS="-c -D -q --no-conf true --disable-ipv6 true"
ARIA2_LOG_FILE=/var/log/JambulaTV/aria2.log
ARIA2_ON_DOWNLOAD_COMPLETE_SCRIPT=/tmp/aria2-on-download-complete.sh
ARIA2_DIRECTORY=$1 
ARIA2_INPUT_FILE=$2 
EMAIL_NOTIFICATION_ADDRESS=$3
EMAIL_NOTIFICATION_SCRIPT=/usr/bin/jambulatv-email
# Default variables if no args 
[ "x$ARIA2_DIRECTORY" = "x" ] && ARIA2_DIRECTORY=/JambulaTV/Podcasts
[ "x$ARIA2_INPUT_FILE" = "x" ] && ARIA2_INPUT_FILE=/JambulaTV/Podcasts/inputfile.DO.NOT.REMOVE
[ "x$EMAIL_NOTIFICATION_ADDRESS" = "x" ] && EMAIL_NOTIFICATION_ADDRESS="user@domain.com"
TELEGRAM_SCRIPT=/usr/bin/jambulatv-telegram
TELEGRAM_API_BOT=""


# Generate 'On-Download-X' Scripts
# ---------------------------------
# Remove existing Aria2c download script
[ -f $ARIA2_ON_DOWNLOAD_COMPLETE_SCRIPT ] && sudo rm -f $ARIA2_ON_DOWNLOAD_COMPLETE_SCRIPT
#
# Generate On-Download-Complete Script
cat > $ARIA2_ON_DOWNLOAD_COMPLETE_SCRIPT << EOF
#!/bin/sh
# Perform the following after aria2 download is completed
#
# Email notifying completion
$EMAIL_NOTIFICATION_SCRIPT $EMAIL_NOTIFICATION_ADDRESS "Podcasts - Download of \$(basename \$3) Completed" "Your podcast is located at \$3"

# Telegram if API Bot exists
TELEGRAM_API_BOT="$TELEGRAM_API_BOT"
if [ "x\$TELEGRAM_API_BOT" != "x" ];
then
/usr/bin/jambulatv-telegram sendmessage \$TELEGRAM_API_BOT "[JambulaTV] The Podcast \$(basename \$3) was successfully downloaded. You may find it under 'Videos >> Files >> Podcasts' on your JambulaTV or \$3. Enjoy!"
else
echo "WARNING: No telegram message sent as it was not configured"
fi

# Check for unfinished downloads
ls $ARIA2_DIRECTORY/*.aria2 > /dev/null 2>&1
UNFINISH_EXISTS=\$?
# Remove Input file if download completed successfully
[ \$UNFINISH_EXISTS != 0 ] && rm -f $ARIA2_INPUT_FILE
EOF
#
# Make script executable
chmod 755 $ARIA2_ON_DOWNLOAD_COMPLETE_SCRIPT


# Add empty input file if non-exists
# ----------------------------------
if [ ! -e $ARIA2_INPUT_FILE ];
then
touch $ARIA2_INPUT_FILE
chmod 666 $ARIA2_INPUT_FILE
fi


# Start/Resume Downloads
# ----------------------
$ARIA2_CMD $ARIA2_OPTIONS -d $ARIA2_DIRECTORY -i $ARIA2_INPUT_FILE -l $ARIA2_LOG_FILE --on-download-complete=$ARIA2_ON_DOWNLOAD_COMPLETE_SCRIPT
