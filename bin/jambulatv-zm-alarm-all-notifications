#!/bin/sh

ZM_CAMERA_ID=$1
ZM_CAMERA_NAME=$2
ZM_CAMERA_EVENT_ID=$3
ZM_TIME=$(date '+%r')
ZM_EVENTS_DIR=/tmp
ZM_HOST_LOCAL=127.0.0.1
ZM_HOST_WIFI=172.16.0.1
ZM_PORT=8520
ZM_ROOT_URL_LOCAL="http://$ZM_HOST_LOCAL:$ZM_PORT"
ZM_ROOT_URL_WIFI="http://$ZM_HOST_WIFI:$ZM_PORT"
ZM_WATCH_URL="$ZM_ROOT_URL_LOCAL/jpeg.cgi?mode=single&monitor=${ZM_CAMERA_ID}&scale=100"

# Domoticz stuff
DOMOTICZ_HOST_IP=jambulatv
DOMOTICZ_WWW_PORT=8540
DOMOTICZ_SECURITY_LAMP_NAME="Living Room"
DOMOTICZ_SECURITY_LAMP_DURATION=60

# Time of Day
HOUR=`date +%H`

# Edit Notification message templates here
NOTIFICATION_SUBJECT="*[JambulaTV] CCTV Security Alert: Motion Detected on $ZM_CAMERA_NAME Camera*"
NOTIFICATION_MESSAGE="Motion Was Detected by Camera No.$ZM_CAMERA_ID ($ZM_CAMERA_NAME) at $ZM_TIME.  The Video of this Event has been logged and is viewable at: $ZM_ROOT_URL_WIFI/index.php?view=event%26eid=${ZM_CAMERA_EVENT_ID}"

# Telegram
TELEGRAM_CREDENTIALS_CONFIG=/etc/JambulaTV/messaging-telegram.cfg

# Email
EMAIL_CREDENTIALS_CONFIG=/etc/JambulaTV/messaging-email.cfg
EMAIL_NOTIFICATION_ADDRESS=$(grep -i EMAIL_TO_ADDRESS $EMAIL_CREDENTIALS_CONFIG | sed '/^#/d' | cut -d = -f2 | sed 's/"//g')
EMAIL_SCRIPT="/usr/bin/jambulatv-email"

# OSD
KODI_OSD_SCRIPT=/usr/bin/jambulatv-zm-alarm-kodi-notifications
OSD_SCRIPT=/usr/bin/jambulatv-osd



###############
#  FUNCTIONS  #
###############
usage () {
# Camera ID
if [ "x$ZM_CAMERA_ID" = "x" ];
then
echo "Usage:  ./`basename $0` [ZM_CAMERA_ID] [ZM_CAMERA_NAME] [ZM_CAMERA_EVENT_ID]
"
exit 1
fi
# Camera Name
if [ "x$ZM_CAMERA_NAME" = "x" ];
then
echo "Usage:  ./`basename $0` $ZM_CAMERA_ID [ZM_CAMERA_NAME] [ZM_CAMERA_EVENT_ID]
"
exit 1
fi
# Camera Event ID
if [ "x$ZM_CAMERA_EVENT_ID" = "x" ];
then
echo "Usage:  ./`basename $0` $ZM_CAMERA_ID $ZM_CAMERA_NAME [ZM_CAMERA_EVENT_ID]
"
exit 1
fi
}

darkness_or_light () {
# Determine weather it is dark or not
if [ "$HOUR" -ge "19" ] || [ "$HOUR" -le "6" ];
then
ITS_DARK=yes
else
ITS_DARK=no
fi
}

get_id_of_lamp () {
DOMOTICZ_SECURITY_LAMP_IDX=$(curl -s "http://$DOMOTICZ_HOST_IP:$DOMOTICZ_WWW_PORT/json.htm?type=command&param=getlightswitches" | jq -c ".result[] | select(.Type == \"Light/Switch\") | select(.Name == \"$DOMOTICZ_SECURITY_LAMP_NAME\") | .idx" | sed "s:\"::g")
export DOMOTICZ_SECURITY_LAMP_IDX
}

status_of_lamp () {
get_id_of_lamp
# Check status of security light
DOMOTICZ_SECURITY_LAMP_STATE=$(curl -s "http://$DOMOTICZ_HOST_IP:$DOMOTICZ_WWW_PORT/json.htm?type=devices&rid=$DOMOTICZ_SECURITY_LAMP_IDX" | jq '.result' | grep -i status | awk {'print $2'} | sed 's:["|,]::g')
}

turn_on_lamp () {
get_id_of_lamp
# Dimmable
curl -s "http://$DOMOTICZ_HOST_IP:$DOMOTICZ_WWW_PORT/json.htm?type=command&param=switchlight&idx=$DOMOTICZ_SECURITY_LAMP_IDX&switchcmd=Set%20Level&level=100" > /dev/null 2>&1
# Non-Dimmable
#curl -s "http://$DOMOTICZ_HOST_IP:$DOMOTICZ_WWW_PORT/json.htm?type=command&param=switchlight&idx=$DOMOTICZ_SECURITY_LAMP_IDX&switchcmd=On" > /dev/null 2>&1
}

turn_off_lamp () {
get_id_of_lamp
# Dimmable
curl -s "http://$DOMOTICZ_HOST_IP:$DOMOTICZ_WWW_PORT/json.htm?type=command&param=switchlight&idx=$DOMOTICZ_SECURITY_LAMP_IDX&switchcmd=Set%20Level&level=0" > /dev/null 2>&1
# Non-Dimmable
curl -s "http://$DOMOTICZ_HOST_IP:$DOMOTICZ_WWW_PORT/json.htm?type=command&param=switchlight&idx=$DOMOTICZ_SECURITY_LAMP_IDX&switchcmd=Off" > /dev/null 2>&1
}

log_event () {
curl -s "http://$DOMOTICZ_HOST_IP:$DOMOTICZ_WWW_PORT/json.htm?type=command&param=addlogmessage&message=$@" > /dev/null 2>&1
}



#################
#  MAIN SCRIPT  #
#################
usage
#
# LAMP
# ----
darkness_or_light 
status_of_lamp
# Turn on security Light if it is not on and its dark 
#if [ "$DOMOTICZ_SECURITY_LAMP_STATE" = "Off" ] && [ "$ITS_DARK" = "yes" ];
if [ "$ITS_DARK" = "yes" ];
then
turn_on_lamp
log_event $NOTIFICATION_MESSAGE
fi


# Capture current camera view
curl -G -s -o $ZM_EVENTS_DIR/camera.${ZM_CAMERA_ID}.jpg $ZM_WATCH_URL


# Telegram
# ---------
# Source Telegram credentials
. $TELEGRAM_CREDENTIALS_CONFIG
# SendMesage
$TELEGRAM_SCRIPT SendMessage "$NOTIFICATION_SUBJECT $NOTIFICATION_MESSAGE. Attached is a snapshot ..."
# SendPhoto
$TELEGRAM_SCRIPT SendImageDisk  $ZM_EVENTS_DIR/camera.$ZM_CAMERA_ID.jpg


# Send Email
# -----------
$EMAIL_SCRIPT $EMAIL_NOTIFICATION_ADDRESS "$NOTIFICATION_SUBJECT" "$NOTIFICATION_MESSAGE" "$ZM_EVENTS_DIR/camera.${ZM_CAMERA_ID}.jpg"


# OSD Message using Doorbell plugin
# ---------------------------------
$KODI_OSD_SCRIPT -i $ZM_CAMERA_ID -n $ZM_CAMERA_NAME -e $ZM_CAMERA_EVENT_ID -t "$ZM_TIME" -m "$NOTIFICATION_MESSAGE"

# OSD Message using jambulatv-osd script
# --------------------------------------
#$OSD_SCRIPT -m "$NOTIFICATION_MESSAGE"

# LAMP
# -----
# Switch off security Light if it was turned on after desired period e.g. 60 minutes
#if [ "$DOMOTICZ_SECURITY_LAMP_STATE" = "On" ] && [ "$ITS_DARK" = "yes" ];
if [ "$ITS_DARK" = "yes" ];
then
sleep $DOMOTICZ_SECURITY_LAMP_DURATION
turn_off_lamp
fi
